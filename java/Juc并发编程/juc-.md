**1.è¿›ç¨‹ä¸çº¿ç¨‹**
===========

## 1.1çº¿ç¨‹ä¸è¿›ç¨‹

##### è¿›ç¨‹

*   ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ï¼Œç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ï¼Œç®¡ç†å†…å­˜ï¼Œç®¡ç†OIçš„ã€‚
*   å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚
*   è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ï¼Œç”»å›¾ï¼Œæµè§ˆå™¨ç­‰ï¼‰ï¼Œä¹Ÿæœ‰ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ï¼Œ360å®‰å…¨å«å£«ç­‰ï¼‰ã€‚

##### çº¿ç¨‹

*   ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚
*   ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œã€‚
*   javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨ã€‚

##### äºŒè€…å¯¹æ¯”

*   è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†ã€‚
*   è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«ã€‚
*   è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚
    *   åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸ºIPCï¼ˆInter-process communication).
    *   ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œå¦‚HTTPã€‚
*   çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ã€‚ä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡ã€‚
*   çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½ã€‚

## 1.2å¹¶è¡Œä¸å¹¶å‘

##### å¹¶å‘

å•æ ¸cpuä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯**ä¸²è¡Œæ‰§è¡Œ**çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°†cpuçš„æ—¶é—´ç‰‡ï¼ˆwindowsä¸‹æ—¶é—´ç‰‡æœ€å°çº¦15æ¯«ç§’ï¼‰åˆ†ç»™ä¸åŒçº¿ç¨‹ä½¿ç”¨ï¼Œåªæ˜¯ç”±äºcpuåœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ã€‚äººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼š**å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ**ã€‚

ä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨cpuçš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼ˆconcurrentï¼‰ã€‚

![](https://img-blog.csdnimg.cn/20210527223210347.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1OTY2NDQw,size_16,color_FFFFFF,t_70)

##### å¹¶è¡Œ

å¤šæ ¸cpuä¸‹ï¼Œæ¯ä¸ªæ ¸ï¼ˆcoreï¼‰éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚

![](https://img-blog.csdnimg.cn/20210527223237766.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1OTY2NDQw,size_16,color_FFFFFF,t_70)

å¼•ç”¨Rob Pikeçš„ä¸€æ®µæè¿°ï¼š

> *   **å¹¶å‘**ï¼ˆconcurrent)æ˜¯**åŒä¸€æ—¶é—´åº”ç›´æ¥å¯¹**ï¼ˆdealing withï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›
> *   **å¹¶è¡Œ**ï¼ˆparallelï¼‰æ˜¯**åŒä¸€æ—¶é—´åŠ¨æ‰‹åš**ï¼ˆdoingï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›ã€‚

## 1.3åº”ç”¨

##### åº”ç”¨ä¹‹å¼‚æ­¥è°ƒç”¨ï¼ˆæ¡ˆä¾‹1ï¼‰

ä»¥è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœ

> *   éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥ã€‚
> *   ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥ã€‚

**ï¼ˆ1ï¼‰è®¾è®¡**

å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³•æ‰§è¡Œå˜ä¸ºå¼‚æ­¥ï¼ˆå³ä¸è¦å¹²å·´å·´ç­‰ç€ï¼‰æ¯”å¦‚è¯´è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œå‡è®¾è¯»å–æ“ä½œèŠ±è´¹äº†5ç§’é’Ÿï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒåº¦æœºåˆ¶ï¼Œè¿™5

ç§’cpuä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå…¶ä»–ä»£ç éƒ½å¾—æš‚åœã€‚

**ï¼ˆ2ï¼‰ç»“è®º**

*   æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè´¹æ—¶æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
*   tomcatçš„å¼‚æ­¥servletä¹Ÿæ˜¯ç±»ä¼¼ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡tomcatçš„å·¥ä½œçº¿ç¨‹ã€‚
*   uiç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡uiçº¿ç¨‹ã€‚

##### åº”ç”¨ä¹‹æé«˜æ•ˆç‡ï¼ˆæ¡ˆä¾‹1ï¼‰

å……åˆ†åˆ©ç”¨å¤šæ ¸cpuçš„ä¼˜åŠ¿ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚æƒ³è±¡ä¸‹é¢çš„åœºæ™¯ï¼Œæ‰§è¡Œ 3 ä¸ªè®¡ç®—ï¼Œæœ€åå°†è®¡ç®—ç»“æœæ±‡æ€»ã€‚

    è®¡ç®—1 èŠ±è´¹ 10 ms
    è®¡ç®—2 èŠ±è´¹ 11 ms
    è®¡ç®—3 èŠ±è´¹ 9 ms
    æ±‡æ€»éœ€è¦ 1 ms


*   å¦‚æœæ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆæ€»å…±èŠ±è´¹çš„æ—¶é—´æ˜¯  
    10 + 11 + 9 + 1 = 31 m s 10+11+9+1=31ms 10+11+9+1\=31ms
    
*   ä½†å¦‚æœæ˜¯å››æ ¸cpuï¼Œå„ä¸ªæ ¸å¿ƒåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹1æ‰§è¡Œè®¡ç®—1ï¼Œçº¿ç¨‹2æ‰§è¡Œè®¡ç®—1ï¼Œçº¿ç¨‹3æ‰§è¡Œè®¡ç®—3ï¼Œé‚£ä¹ˆ3ä¸ªçº¿ç¨‹æ˜¯å¹¶è¡Œçš„å—ï¼ŒèŠ±è´¹æ—¶é—´åªå–å†³äºæœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹è¿è¡Œçš„æ—¶é—´ï¼Œ`11ms`æœ€ååŠ ä¸Šæ±‡æ€»æ—¶é—´æ€»å…±åªèŠ±è´¹ `12ms`ã€‚
    

> æ³¨æ„
>
> éœ€è¦åœ¨å¤šæ ¸cpuä¸­æ‰èƒ½æé«˜æ•ˆç‡ï¼Œå•æ ¸ä»ç„¶æ˜¯è½®æµæ‰§è¡Œ

**ï¼ˆ1ï¼‰æ‰§è¡Œ**

**ï¼ˆ2ï¼‰ç»“è®º**

1.  å•æ ¸cpuä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹åˆ‡æ¢è½®æµä½¿ç”¨cpuï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨cpuï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»ã€‚
2.  å¤šæ ¸cpuå¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„
    *   æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œä½†ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»»åŠ¡éƒ½èƒ½æ‹†åˆ†ã€‚ï¼ˆå‚è€ƒåæ–‡çš„ã€é˜¿å§†è¾¾å®šå¾‹ã€‘ï¼‰ã€‚
    *   ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡å•¥æ„ä¹‰ã€‚
3.  IOæ“ä½œä¸å ç”¨cpuï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ã€é˜»å¡IOã€‘ï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨cpuï¼Œä½†éœ€è¦ä¸€ç›´ç­‰å¾…IOç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ï¼Œæ‰€æœ‰æ‰æœ‰åé¢çš„ã€éé˜»å¡IOã€‘å’Œã€å¼‚æ­¥IOã€‘ä¼˜åŒ–ã€‚



2.Javaçº¿ç¨‹
==============================================================================================================

æœ¬æ–‡ç« è§†é¢‘æŒ‡è·¯ğŸ‘‰[é»‘é©¬ç¨‹åºå‘˜-å¹¶å‘ç¼–ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd?p=50)

1.åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹
---------

### 1-1 æ–¹æ³•ä¸€ï¼šç›´æ¥ä½¿ç”¨Thread

    // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    Thread t = new Thread() {
        public void run() {
         // è¦æ‰§è¡Œçš„ä»»åŠ¡
        }
    };
    // å¯åŠ¨çº¿ç¨‹
    t.start();


ä¾‹å¦‚ï¼š

    // æ„é€ æ–¹æ³•çš„å‚æ•°æ˜¯ç»™çº¿ç¨‹æŒ‡å®šåå­—ï¼Œæ¨è
    Thread t1 = new Thread("t1") {
        @Override
        // run æ–¹æ³•å†…å®ç°äº†è¦æ‰§è¡Œçš„ä»»åŠ¡
        public void run() {
            log.debug("hello");
        }
    };
    t1.start();


### 1-2 æ–¹æ³•äºŒï¼šä½¿ç”¨Runnableé…åˆThread

æŠŠã€çº¿ç¨‹ã€‘å’Œã€ä»»åŠ¡ã€‘ï¼ˆè¦æ‰§è¡Œçš„ä»£ç ï¼‰åˆ†å¼€

*   Threadä»£è¡¨çº¿ç¨‹
    
*   Runnableå¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰
    
        public class Test2 {
            public static void main(String[] args) {
                //åˆ›å»ºçº¿ç¨‹ï¼Œå°†Runnableå¯¹è±¡ä¼ å…¥è¿›æ¥
                Thread t = new Thread(new Runnable() {
                    @Override
                    public void run() {
                        System.out.println("Run");
                    }
                }, "xpp");
                t.start();
            }
        }
    
    
    > java8ä»¥åå¯ä»¥ä½¿ç”¨lambdaç²¾ç®€ä»£ç 
    
        public class Test2 {
            public static void main(String[] args) {
                Thread t = new Thread(() -> System.out.println("Run"), "xpp");
                t.start();
            }
        }
    
    

**åŸç†ä¹‹Threadä¸Runnableçš„å…³ç³»ï¼š**

åˆ†æThreadçš„æºç ï¼Œç†æ¸…å®ƒä¸Runnableçš„å…³ç³»

*   æ–¹æ³•1æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ–¹æ³•2æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†ï¼ˆæ¨èæ–¹æ³•2ï¼‰ã€‚
*   ç”¨Runnableæ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§APIé…åˆã€‚
*   ç”¨Runnableè®©ä»»åŠ¡ç±»è„±ç¦»äº†Threadç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»ã€‚

### 1-3 æ–¹æ³•ä¸‰ï¼šFutureTaské…åˆThread

FutureTaskèƒ½å¤Ÿæ¥å—Callableç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µã€‚

    public class Test3 {
        public static void main(String[] args) throws ExecutionException, InterruptedException {
            //åˆ›å»ºä»»åŠ¡å¯¹è±¡ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªCallableå¯¹è±¡
            FutureTask<Integer> task=new FutureTask<>(new Callable<Integer>() {
                @Override
                public Integer call() throws Exception {
                    System.out.println("running...");
                    Thread.sleep(1000);
                    return 100;
                }
            });
            Thread t1 = new Thread(task, "t1");
            t1.start();
            //è·å–çº¿ç¨‹ä¸­æ–¹æ³•æ‰§è¡Œåè¿”å›çš„ç»“æœ
            System.out.println(task.get());//getæ–¹æ³•ä¼šä¸€ç›´ç­‰å¾…taskå®Œæˆï¼Œæ‰ä¼šå¾—åˆ°ç»“æœ
            
        }
    }


2.è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ
------------

    @Slf4j
    public class TestMultiThread {
        public static void main(String[] args) {
            new Thread(() -> {
                while (true) {
                    log.debug("running");
                }
            }, "t1").start();
            new Thread(() -> {
                while (true) {
                    log.debug("running");
                }
            }, "t2").start();
        }
    }


å¾—å‡ºçš„ç»“æœï¼š

*   äº¤æ›¿æ‰§è¡Œ
*   è°å…ˆè°åï¼Œä¸ç”±æˆ‘ä»¬æ§åˆ¶

3.æŸ¥çœ‹è¿›ç¨‹çº¿ç¨‹çš„æ–¹æ³•
-----------

**windows**

*   ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥ç›´æ¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹ã€‚
    
*   `tasklist`æŸ¥çœ‹è¿›ç¨‹ï¼ˆé€šè¿‡cmdï¼‰ã€‚
    
*   `taskkill`æ€æ­»è¿›ç¨‹ã€‚
    

**linux**

*   `ps -fe`æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ã€‚
*   `ps -fT -p <PID>`æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹ã€‚
*   `kill <PID>`æ€æ­»è¿›ç¨‹ã€‚
*   `top`æŒ‰å¤§å†™Håˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹ã€‚
*   `top -H -p <PID>`æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹ã€‚

**Java**

*   `jps`å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰Javaè¿›ç¨‹ã€‚
*   `jstack <PID>`æŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€ã€‚
*   `jconsole`æ¥æŸ¥çœ‹æŸä¸ªJavaçº¿ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰ã€‚

4.åŸç†ä¹‹çº¿ç¨‹è¿è¡Œ
---------

**æ ˆä¸æ ˆå¸§**

Java Virtual Machine Stacks(Java è™šæ‹Ÿæœºæ ˆ)

æˆ‘ä»¬éƒ½çŸ¥é“JVMä¸­ç”±å †ï¼Œæ ˆï¼Œæ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚

*   æ¯ä¸ªæ ˆæœ‰å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜ã€‚
*   æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•ã€‚

**çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰**

å› ä¸ºä¸€ä¸‹ä¸€äº›åŸå› å¯¼è‡´cpuä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç ã€‚

*   çº¿ç¨‹çš„cpuæ—¶é—´ç‰‡ç”¨å®Œã€‚
*   åƒåœ¾å›æ”¶ã€‚
*   æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œã€‚
*   çº¿ç¨‹è‡ªå·±è°ƒç”¨slepp,yield,wait,join,park,synchronized,lockç­‰æ–¹æ³•ã€‚

å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿ**ä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€**ï¼ŒJavaä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡jvmæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯**çº¿ç¨‹ç§æœ‰çš„**ã€‚

*   çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼Œè™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ï¼Œæ“ä½œæ•°æ ˆï¼Œè¿”å›åœ°å€ç­‰ã€‚
*   Context Switch é¢‘ç¹å‘ç”Ÿå½±å“æ€§èƒ½ã€‚

5.å¸¸ç”¨æ–¹æ³•
------

æ–¹æ³•å

static

åŠŸèƒ½è¯´æ˜

æ³¨æ„

start()

å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­çš„ä»£ç 

start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥**å°±ç»ª**ï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„ startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° IllegalThreadStateException

run()

æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•

å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œ æ¥è¦†ç›–é»˜è®¤è¡Œä¸º

join()

ç­‰çº¿ç¨‹è¿è¡Œç»“æŸ

join(long n)

ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæœ€å¤šç­‰å¾…næ¯«ç§’

getld()

è·å–çº¿ç¨‹é•¿æ•´å‹çš„id

idå”¯ä¸€

getName()

è·å–çº¿ç¨‹å

setName(String)

ä¿®æ”¹çº¿ç¨‹å

getPriority()

è·å–çº¿ç¨‹ä¼˜å…ˆçº§

setPriority(int)

ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§

javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10 çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§èƒ½æé«˜è¯¥çº¿ç¨‹è¢« CPU è°ƒåº¦çš„æœºç‡

getState()

è·å–çº¿ç¨‹çŠ¶æ€

Java ä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨ 6 ä¸ª enum è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼š NEW, RUNNABLE, BLOCKED, WAITING, TIMED\_WAITING, TERMINATED

isInterrupted()

åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­

ä¸ä¼šæ¸…é™¤ `æ‰“æ–­æ ‡è®°`

isAlive()

çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰

interrupt()

æ‰“æ–­çº¿ç¨‹

å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨ sleepï¼Œwaitï¼Œjoin ä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡º InterruptedExceptionï¼Œå¹¶æ¸…é™¤`æ‰“æ–­æ ‡è®°` ï¼›å¦‚æœæ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½®`æ‰“æ–­æ ‡è®°` ï¼›park çš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½®`æ‰“æ–­æ ‡è®°`

interrupted()

static

åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­

ä¼šæ¸…é™¤`æ‰“æ–­æ ‡è®°`

currentThread()

static

è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹

sleep(long n)

static

è®©å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ næ¯«ç§’ï¼Œä¼‘çœ æ—¶è®©å‡ºcpuçš„æ—¶é—´ç‰‡ç»™å…¶å®ƒçº¿ç¨‹

yield()

static

æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹cpuçš„ä½¿ç”¨

ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•

### 5-1 startä¸run

**start**

1.  å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­çš„ä»£ç ã€‚
2.  start æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥**å°±ç»ª**ï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„ startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° `IllegalThreadStateException`

**run**

1.  æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•ã€‚
2.  å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œ æ¥è¦†ç›–é»˜è®¤è¡Œä¸º

**è°ƒç”¨run**

ç¨‹åºè¿˜æ˜¯åœ¨mainçº¿ç¨‹æ‰§è¡Œï¼Œè¿˜æ˜¯åŒæ­¥æ‰§è¡Œçš„

    @Slf4j
    public class Test4 {
        public static void main(String[] args) {
            Thread t1 = new Thread("t1") {
                @Override
                public void run() {
                    log.debug("running...");
                }
            };
            t1.run();
            log.debug("running");
        }
    }


è¾“å‡º

    12:17:47 DEBUG [main] (Test4.java:11) - running...
    12:17:47 DEBUG [main] (Test4.java:15) - runnin


**è°ƒç”¨start**

æ­¤æ—¶æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œå¼‚æ­¥æ‰§è¡Œ

    @Slf4j
    public class Test4 {
        public static void main(String[] args) {
            Thread t1 = new Thread("t1") {
                @Override
                public void run() {
                    log.debug("running...");
                }
            };
            t1.start();
            log.debug("running");
        }
    }


è¾“å‡º

    12:14:15 DEBUG [main] (Test4.java:15) - running
    12:14:15 DEBUG [t1] (Test4.java:11) - running...


**å°ç»“**

*   ç›´æ¥è°ƒç”¨runæ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº†runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹ã€‚
*   ä½¿ç”¨startæ˜¯å¯åŠ¨äº†æ–°çš„çº¿ç¨‹ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œrunä¸­çš„ä»£ç ã€‚

### 5-2 sleepä¸yield

**sleep**

1.  è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» `Running` è¿›å…¥ `Timed Waiting` çŠ¶æ€ï¼Œå¯é€šè¿‡state()æ–¹æ³•æŸ¥çœ‹
    
2.  å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ `interrupt` æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º `InterruptedException`
    
3.  ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ
    
4.  å»ºè®®ç”¨ `TimeUnit` çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§ ã€‚
    
        //ä¼‘çœ ä¸€ç§’
        TimeUnit.SECONDS.sleep(1);
        //ä¼‘çœ ä¸€åˆ†é’Ÿ
        TimeUnit.MINUTES.sleep(1);
    
    

**yield**

1.  è°ƒç”¨ yield ä¼šè®©å½“å‰çº¿ç¨‹ä» `Running` è¿›å…¥ `Runnable` å°±ç»ªçŠ¶æ€ï¼ˆä»ç„¶æœ‰å¯èƒ½è¢«æ‰§è¡Œï¼‰ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒçº¿ç¨‹
2.  å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨

**çº¿ç¨‹ä¼˜å…ˆçº§**

*   çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚
*   å¦‚æœcpuæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†cpué—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨ã€‚

ä¸¾ä¸ªæ —å­ï¼š

    @Slf4j
    public class Test9 {
        public static void main(String[] args) throws InterruptedException {
            Runnable task1 = () -> {
                int count = 0;
                for (; ; ) {
                    System.out.println("--->1  " + count++);
                }
            };
            Runnable task2 = () -> {
                int count = 0;
                for (; ; ) {
                    Thread.yield();
                    System.out.println("  --->2  " + count++);
                }
            };
            Thread t1 = new Thread(task1, "t1");
            Thread t2 = new Thread(task2, "t2");
    		//t1.setPriority(Thread.MAX_PRIORITY);
    	    //t2.setPriority(Thread.MIN_PRIORITY);
            t1.start();
            t2.start();
    
        }
    }


![](https://img-blog.csdnimg.cn/9ce3c84dede24145833a35a8157ab94a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

å¯ä»¥çœ‹å‡º`yield()`èµ·åˆ°äº†ä½œç”¨ï¼Œt2è¿›å…¥`Runnable`çŠ¶æ€ï¼Œå¼€å¯è®¾ç½®ä¼˜å…ˆçº§åç»“æœä¹Ÿç±»ä¼¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ€ç»ˆçš„ç»“æœæ— è®ºæ˜¯å“ªç§æ–¹å¼ï¼Œ**éƒ½æ˜¯ç”±è°ƒåº¦å™¨å†³å®šæœ€åæ—¶é—´ç‰‡çš„åˆ†é…**

### 5-3 joinæ–¹æ³•è¯¦è§£

**join**

ç”¨äºç­‰å¾…æŸä¸ªçº¿ç¨‹ç»“æŸã€‚å“ªä¸ªçº¿ç¨‹å†…è°ƒç”¨join()æ–¹æ³•ï¼Œå°±ç­‰å¾…å“ªä¸ªçº¿ç¨‹ç»“æŸï¼Œç„¶åå†å»æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦join**ï¼Ÿ

    @Slf4j
    public class Test10 {
        static int r = 0;
        public static void main(String[] args) {
            test1();
    
        }
        private static void test1() {
            log.debug("å¼€å§‹");
            Thread t1 = new Thread(() -> {
                log.debug("å¼€å§‹");
                try {
                    sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("ç»“æœ");
                r = 10;
            });
            t1.start();
            //t1.join();
            log.debug("ç»“æœä¸º:{}", r);
            log.debug("ç»“æŸ");
        }
    }
    13:36:47 DEBUG [main] (Test10.java:18) - å¼€å§‹
    13:36:47 DEBUG [Thread-0] (Test10.java:20) - å¼€å§‹
    13:36:47 DEBUG [main] (Test10.java:30) - ç»“æœä¸º:0
    13:36:47 DEBUG [main] (Test10.java:31) - ç»“æŸ
    13:36:48 DEBUG [Thread-0] (Test10.java:26) - ç»“æŸ


**åˆ†æ**

*   å› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹t1æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1çº¿ç¨‹éœ€è¦1ç§’ä¹‹åæ‰èƒ½ç®—å‡º`r=10`ã€‚
*   è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å°rçš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°å‡º`r=0`ã€‚

**è§£å†³æ–¹æ³•**

*   ç”¨**join**ï¼ŒåŠ åœ¨`t1.start()`ä¹‹åå³å¯ã€‚

**åº”ç”¨ä¹‹åŒæ­¥ï¼š**

ä»¥è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœ

*   éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯**åŒæ­¥**ã€‚
*   ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯**å¼‚æ­¥**ã€‚

### 5-4 interruptæ–¹æ³•è¯¦è§£

ç”¨äºæ‰“æ–­**é˜»å¡**(sleep wait joinâ€¦)çš„çº¿ç¨‹ã€‚ å¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ï¼ŒCPUä¸ä¼šç»™å…¶åˆ†é…æ—¶é—´ç‰‡ã€‚

*   å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨åœ¨è¿è¡Œä¸­è¢«æ‰“æ–­ï¼Œæ‰“æ–­æ ‡è®°ä¼šè¢«ç½®ä¸º**true**ã€‚
*   å¦‚æœæ˜¯æ‰“æ–­å› sleep wait joinæ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œä¼šå°†æ‰“æ–­æ ‡è®°ç½®ä¸º**false**

**æ‰“æ–­sleepï¼Œwaitï¼Œjoinçš„çº¿ç¨‹**

è¿™é‡Œä»¥sleepä¸ºä¾‹ï¼š

    @Slf4j
    public class Test11 {
        public static void main(String[] args) throws InterruptedException {
            Thread t1 = new Thread(() -> {
                log.debug("sleep...");
                try {
                    Thread.sleep(5000);//wait,join
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }, "t1");
            t1.start();
            Thread.sleep(1000);
            log.debug("interrupt");
            t1.interrupt();
            log.debug("æ‰“æ–­æ ‡è®°:{}", t1.isInterrupted());//false
        }
    }


**æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹**

æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€

    @Slf4j
    public class Test12 {
        public static void main(String[] args) throws InterruptedException {
            Thread t1 = new Thread(() -> {
                while (true) {
                    boolean interrupted = Thread.currentThread().isInterrupted();
                    if (interrupted) {
                        log.debug("é€€å‡ºå¾ªç¯ï¼");
                        break;
                    }
                }
            }, "t1");
            t1.start();
            Thread.sleep(1000);
            log.debug("interrupt");
            t1.interrupt();
            log.debug("æ‰“æ–­æ ‡è®°:{}", t1.isInterrupted());//true
        }
    }
    18:51:03 DEBUG [main] (Test12.java:20) - interrupt
    18:51:03 DEBUG [t1] (Test12.java:13) - æ¨å‡ºå¾ªç¯ï¼
    18:51:03 DEBUG [main] (Test12.java:22) - æ‰“æ–­æ ‡è®°:true


**æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢ï¼š**

![](https://img-blog.csdnimg.cn/img_convert/ae56c5bf209dbb9cbb27993bc676050d.png)

ä»£ç å®ç°ï¼š

    @Slf4j
    public class Test23 {
        public static void main(String[] args) throws InterruptedException {
            TwoPhaseTermination tpt = new TwoPhaseTermination();
            tpt.start();
            Thread.sleep(3500);
            tpt.stop();
        }
    }
    
    @Slf4j
    class TwoPhaseTermination {
        private Thread monitor;//è®¾ç½®ç›‘æ§çº¿ç¨‹
    
        //å¯åŠ¨ç›‘æ§çº¿ç¨‹
        public void start() {
            monitor = new Thread(() -> {
                while (true) {
                    Thread current = Thread.currentThread();
                    if (current.isInterrupted()) {
                        log.debug("æ–™ç†åäº‹");
                        //ç»ˆæ­¢çº¿ç¨‹æ‰§è¡Œ
                        break;
                    }
                    try {
                        Thread.sleep(1000); //æƒ…å†µ1ï¼Œsleepæ‰“æ–­ï¼Œæ‰“æ–­æ ‡è®°ä¸ºfalse
                        log.debug("æ‰§è¡Œç›‘æ§è®°å½•");  //æƒ…å†µ2ï¼Œæ­£å¸¸æ‰“æ–­,æ‰“æ–­æ ‡è®°ä¸ºtrue
                    } catch (InterruptedException e) { //æƒ…å†µ1
                        e.printStackTrace();
                        current.interrupt();//é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°
                    }
                }
            }, "monitor");
            monitor.start();
        }
    
        //åœæ­¢ç›‘æ§çº¿ç¨‹
        public void stop() {
            //æ‰“æ–­çº¿ç¨‹
            monitor.interrupt();
        }
    }


### 5-5 ä¸æ¨èçš„æ‰“æ–­æ–¹æ³•

è¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“**ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”**ï¼

*   stop()ï¼šåœæ­¢çº¿ç¨‹è¿è¡Œï¼ˆå¯èƒ½é€ æˆå…±äº«èµ„æºæ— æ³•è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•ä½¿ç”¨è¿™äº›å…±äº«èµ„æºï¼‰
*   suspend()ï¼šï¼ˆæš‚åœçº¿ç¨‹ï¼‰
*   resume()ï¼šï¼ˆæ¢å¤çº¿ç¨‹ï¼‰æ–¹æ³•

6.ä¸»çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹
----------

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œ**åªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚**

æ —å­ï¼š

    @Slf4j
    public class Test15 {
        public static void main(String[] args) throws InterruptedException {
            Thread t1 = new Thread(() -> {
                while (true) {
                    if (Thread.currentThread().isInterrupted()) {
                        break;
                    }
                }
                log.debug("ç»“æŸ");
            }, "t1");
            t1.setDaemon(true);//è®¾ç½®t1ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œå³ä½¿ä¸»çº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œt1çº¿ç¨‹ä¹Ÿä¼šç»“æŸï¼Œä¸ä¼šæ­»å¾ªç¯
            t1.start();
            Thread.sleep(1000);
            log.debug("ç»“æŸ");
        }
    }


**å®ˆæŠ¤çº¿ç¨‹çš„åº”ç”¨**

*   åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹
*   Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚

7.çº¿ç¨‹çš„çŠ¶æ€
-------

### 7-1 äº”ç§çŠ¶æ€

è¿™æ˜¯ä» **æ“ä½œç³»ç»Ÿ** å±‚é¢æ¥æè¿°çš„

![](https://img-blog.csdnimg.cn/img_convert/579fa80745b73c5352b5077347b59a59.png)

*   **åˆå§‹çŠ¶æ€**ï¼šä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼ˆä¾‹å¦‚çº¿ç¨‹è°ƒç”¨äº†startæ–¹æ³•ï¼‰
*   **å¯è¿è¡ŒçŠ¶æ€**ï¼šï¼ˆ**å°±ç»ªçŠ¶æ€**ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”± CPU è°ƒåº¦æ‰§è¡Œ
*   **è¿è¡ŒçŠ¶æ€**ï¼šæŒ‡è·å–äº† CPU æ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€
    *   å½“ CPU æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢
*   **é˜»å¡çŠ¶æ€**ï¼š
    *   å¦‚æœè°ƒç”¨äº†é˜»å¡ APIï¼Œå¦‚ BIO è¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ° CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ ã€é˜»å¡çŠ¶æ€ã€‘
    *   ç­‰ BIO æ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘
    *   ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘è°ƒåº¦å®ƒä»¬
*   **ç»ˆæ­¢çŠ¶æ€**ï¼šè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€

### 7-2 å…­ç§çŠ¶æ€

è¿™æ˜¯ä» **Java API** å±‚é¢æ¥æè¿°çš„ï¼Œæ ¹æ® Thread.State æšä¸¾ï¼Œåˆ†ä¸ºå…­ç§çŠ¶æ€

![](https://img-blog.csdnimg.cn/img_convert/5e86fdc35e7c4d5d14cc16c40af073fc.png)

*   **NEW** çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨ start() æ–¹æ³•
*   **RUNNABLE** å½“è°ƒç”¨äº† start() æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava API å±‚é¢çš„ RUNNABLE çŠ¶æ€æ¶µç›–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„ ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äº BIO å¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨ Java é‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸ºæ˜¯å¯è¿è¡Œï¼‰
*   **BLOCKED ï¼Œ WAITING ï¼Œ TIMED\_WAITING** éƒ½æ˜¯ **Java API å±‚é¢**å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ï¼Œå¦‚sleepå°±ä½TIMED\_WAITINGï¼Œ joinä¸ºWAITINGçŠ¶æ€ã€‚åé¢ä¼šåœ¨çŠ¶æ€è½¬æ¢ä¸€èŠ‚è¯¦è¿°ã€‚
*   **TERMINATED** å½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸ

è¿™é‡Œé™„ã€Šå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¿™æœ¬ä¹¦çš„ä¸€å¼ å›¾ï¼š

![](https://img-blog.csdnimg.cn/656706c3ffec4da68b65846e97b8b5bd.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1OTY2NDQw,size_16,color_FFFFFF,t_70)

ä¸¾ä¸ªæ —å­ï¼š

    @Slf4j
    public class Test16 {
        static Object obj;
    
        public static void main(String[] args) {
            //new
            Thread t1 = new Thread("t1") {
                @Override
                public void run() {
                    log.debug("running...");
                }
            };
            //runnable
            Thread t2 = new Thread("t2") {
                @Override
                public void run() {
                    while (true) {
    
                    }
                }
            };
            t2.start();
            //terminated
            Thread t3 = new Thread("t3") {
                @Override
                public void run() {
                    log.debug("running...");
                }
            };
            t3.start();
            //timed_waiting
            Thread t4 = new Thread("t4") {
                @Override
                public void run() {
                    try {
                        Thread.sleep(1000000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            };
            t4.start();
            //waiting
            Thread t5 = new Thread("t5") {
                @Override
                public void run() {
                    synchronized (Test16.class) {
                        try {
                            t2.join();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                }
            };
            t5.start();
            //blocked
            Thread t6 = new Thread("t6") {
                @Override
                public void run() {
                    synchronized (Test16.class) {
                        try {
                            Thread.sleep(1000000);
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                }
            };
            t6.start();
    
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
    
            log.debug("t1 state {}", t1.getState());
            log.debug("t2 state {}", t2.getState());
            log.debug("t3 state {}", t3.getState());
            log.debug("t4 state {}", t4.getState());
            log.debug("t5 state {}", t5.getState());
            log.debug("t6 state {}", t6.getState());
        }
    }
    //è¾“å‡º
    21:44:51 DEBUG [t3] (Test16.java:31) - running...
    21:44:51 DEBUG [main] (Test16.java:82) - t1 state NEW
    21:44:51 DEBUG [main] (Test16.java:83) - t2 state RUNNABLE
    21:44:51 DEBUG [main] (Test16.java:84) - t3 state TERMINATED
    21:44:51 DEBUG [main] (Test16.java:85) - t4 state TIMED_WAITING
    21:44:51 DEBUG [main] (Test16.java:86) - t5 state WAITING
    21:44:51 DEBUG [main] (Test16.java:87) - t6 state BLOCKED



3.å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹
===============================================================================================================

æœ¬æ–‡ç« è§†é¢‘æŒ‡è·¯ğŸ‘‰[é»‘é©¬ç¨‹åºå‘˜-å¹¶å‘ç¼–ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd?from=search&seid=2279329274369061723&spm_id_from=333.337.0.0)

1.å…±äº«å¸¦æ¥çš„é—®é¢˜
---------

### 1-1 ä¸´ç•ŒåŒº Critical Section

*   ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„
*   é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®**å…±äº«èµ„æº**
    *   å¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºå…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜
    *   å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æº**è¯»å†™**æ“ä½œæ—¶**å‘ç”ŸæŒ‡ä»¤äº¤é”™**ï¼Œå°±ä¼šå‡ºç°é—®é¢˜
*   ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸º**ä¸´ç•ŒåŒº**

ä¾‹å¦‚ï¼Œä¸‹é¢ä»£ç ä¸­çš„ä¸´ç•ŒåŒºï¼š

    static int counter = 0;
     
    static void increment() 
    // ä¸´ç•ŒåŒº 
    {   
        counter++; 
    }
     
    static void decrement() 
    // ä¸´ç•ŒåŒº 
    { 
        counter--; 
    }


### 1-2 ç«æ€æ¡ä»¶ Race Condition

å¤šä¸ªçº¿ç¨‹åœ¨**ä¸´ç•ŒåŒº**å†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„**æ‰§è¡Œåºåˆ—ä¸åŒ**è€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†**ç«æ€æ¡ä»¶**

2.synchronized è§£å†³æ–¹æ¡ˆ
-------------------

### 2-1 è§£å†³æ–¹æ¡ˆ

ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚

*   **é˜»å¡å¼**çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼ŒLock
*   **éé˜»å¡å¼**çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡

è¯¥èŠ‚ä½¿ç”¨é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼š`synchronized`ï¼Œæ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå³ä¿—ç§°çš„\*\*ã€å¯¹è±¡é”ã€‘**ï¼Œå®ƒé‡‡ç”¨**äº’æ–¥\*\*çš„æ–¹å¼è®©åŒä¸€ æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½(blocked)ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é” çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

> æ³¨æ„ï¼š
>
> è™½ç„¶ java ä¸­**äº’æ–¥**å’Œ**åŒæ­¥**éƒ½å¯ä»¥é‡‡ç”¨ `synchronized` å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š
>
> *   äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
> *   åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹

`synchronized` å®é™…æ˜¯ç”¨**å¯¹è±¡é”**ä¿è¯äº†**ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§**ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚

### 2-2 synchronized çš„ä½¿ç”¨

è¯­æ³•

    synchronized(å¯¹è±¡) {
    	//ä¸´ç•ŒåŒº
    }


è§£å†³

    static int counter = 0; 
    //åˆ›å»ºä¸€ä¸ªå…¬å…±å¯¹è±¡ï¼Œä½œä¸ºå¯¹è±¡é”çš„å¯¹è±¡
    static final Object room = new Object();
     
    public static void main(String[] args) throws InterruptedException {    
    	Thread t1 = new Thread(() -> {        
        for (int i = 0; i < 5000; i++) {            
            synchronized (room) {     
            counter++;            
           	 }       
     	   }    
        }, "t1");
     
        Thread t2 = new Thread(() -> {       
            for (int i = 0; i < 5000; i++) {         
                synchronized (room) {            
                counter--;          
                }    
            } 
        }, "t2");
     
        t1.start();    
        t2.start(); 
        t1.join();   
        t2.join();    
        log.debug("{}",counter); 
    }


### 2-3 æ–¹æ³•ä¸Šçš„synchronized

*   åŠ åœ¨**æˆå‘˜æ–¹æ³•**ä¸Šï¼Œé”æ˜¯å½“å‰**å®ä¾‹å¯¹è±¡**
    
        public class Demo {
        	//åœ¨æ–¹æ³•ä¸ŠåŠ ä¸Šsynchronizedå…³é”®å­—
        	public synchronized void test() {
        	
        	}
        	//ç­‰ä»·äº
        	public void test() {
        		synchronized(this) {
        		
        		}
        	}
        }
    
*   åŠ åœ¨**é™æ€æ–¹æ³•**ä¸Šï¼Œé”æ˜¯å½“å‰**ç±»çš„Classå¯¹è±¡**
    
        public class Demo {
        	//åœ¨é™æ€æ–¹æ³•ä¸ŠåŠ ä¸Šsynchronizedå…³é”®å­—
        	public synchronized static void test() {
        	
        	}
        	//ç­‰ä»·äº
        	public void test() {
        		synchronized(Demo.class) {
        		
        		}
        	}
        }
    
    

3.å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ
-----------

### 3-1 æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

*   å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨
*   å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ
    *   å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨
    *   å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

### 3-2 å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

*   å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„
    
*   ä½†**å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡**åˆ™æœªå¿… ï¼ˆè¦çœ‹è¯¥å¯¹è±¡æ˜¯å¦è¢«å…±äº«ä¸”è¢«æ‰§è¡Œäº†è¯»å†™æ“ä½œï¼‰
    
    *   å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„
    *   å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨
*   å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„â€”æ¯ä¸ªæ–¹æ³•éƒ½åœ¨å¯¹åº”çº¿ç¨‹çš„æ ˆä¸­åˆ›å»ºæ ˆå¸§ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å…±äº«
    
    ![](https://img-blog.csdnimg.cn/img_convert/3fac3d1e094511ad36456a907d5bcdab.png)
    
*   å¦‚æœè°ƒç”¨çš„å¯¹è±¡è¢«å…±äº«ï¼Œä¸”æ‰§è¡Œäº†è¯»å†™æ“ä½œï¼Œåˆ™**çº¿ç¨‹ä¸å®‰å…¨**
    
    ![](https://img-blog.csdnimg.cn/img_convert/b2fd2dfb784f58b8399b884f4646f673.png)
    
*   å¦‚æœæ˜¯å±€éƒ¨å˜é‡ï¼Œåˆ™ä¼šåœ¨å †ä¸­åˆ›å»ºå¯¹åº”çš„å¯¹è±¡ï¼Œä¸ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜
    
    ![](https://img-blog.csdnimg.cn/img_convert/22c5cd7a1ffa0810bb5883c414e3f3ff.png)
    

### 3-3 å¸¸è§çº¿ç¨‹å®‰å…¨ç±»

*   String
*   Integer
*   StringBffer
*   Random
*   Vector ï¼ˆListçš„çº¿ç¨‹å®‰å…¨å®ç°ç±»ï¼‰
*   Hashtable ï¼ˆHashçš„çº¿ç¨‹å®‰å…¨å®ç°ç±»ï¼‰
*   java.util.concurrent åŒ…ä¸‹çš„ç±»

è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬**åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶**ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„

ä¾‹å¦‚ï¼š

    Hashtable table = new Hashtable();
    
    new Thread(()->{
        table.put("key", "value1");
    }).start();
    new Thread(()->{
        table.put("key", "value2");
    }).start();


*   å®ƒä»¬çš„**æ¯ä¸ªæ–¹æ³•**æ˜¯**åŸå­çš„**ï¼ˆéƒ½è¢«åŠ ä¸Šäº†**synchronized**ï¼‰
*   ä½†æ³¨æ„å®ƒä»¬**å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„**ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜

**çº¿ç¨‹å®‰å…¨ç±»æ–¹æ³•çš„ç»„åˆ**

åˆ†æä¸‹é¢ä»£ç æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

    Hashtable table = new Hashtable();
    // çº¿ç¨‹1ï¼Œçº¿ç¨‹2
    if( table.get("key") == null) {
        table.put("key", value);
    }


![](https://img-blog.csdnimg.cn/44f51b70fe574e7d90e52d248b60b719.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

å¯ä»¥å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜

**ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨æ€§**

Stringã€Integer ç­‰éƒ½æ˜¯**ä¸å¯å˜ç±»**ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼ŒString æœ‰ replaceï¼Œsubstring ç­‰æ–¹æ³•å¯ä»¥æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºè¿™äº›æ–¹æ³•çš„è¿”å›å€¼éƒ½**åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡**ï¼Œè€Œä¸æ˜¯ç›´æ¥æ”¹å˜Stringã€Integerå¯¹è±¡æœ¬èº«ã€‚

### 3-4 å®ä¾‹åˆ†æ

ä¾‹1ï¼š

    public class MyServlet extends HttpServlet {
        // æ˜¯å¦å®‰å…¨ï¼Ÿno
        Map<String,Object> map = new HashMap<>();
        // æ˜¯å¦å®‰å…¨ï¼Ÿyes
        String S1 = "...";
        // æ˜¯å¦å®‰å…¨ï¼Ÿyes
        final String S2 = "...";
        // æ˜¯å¦å®‰å…¨ï¼Ÿno
        Date D1 = new Date();
        // æ˜¯å¦å®‰å…¨ï¼Ÿno,å¼•ç”¨ä¸å˜ï¼Œä½†æ˜¯é‡Œé¢çš„å¹´æœˆæ—¥æ˜¯å¯å˜çš„
        final Date D2 = new Date();
    
        public void doGet(HttpServletRequest request, HttpServletResponse response) {
            //ä½¿ç”¨ä¸Šè¿°å˜é‡
        }
    }


ä¾‹2ï¼š

    public class MyServlet extends HttpServlet {
        // æ˜¯å¦å®‰å…¨ï¼Ÿnoï¼Œå…±äº«çš„
        private UserService userService = new UserServiceImpl();
    
        public void doGet(HttpServletRequest request, HttpServletResponse response) {
            userService.update(...);
        }
    }
    public class UserServiceImpl implements UserService {
        // è®°å½•è°ƒç”¨æ¬¡æ•°
        private int count = 0;//è¿™é‡Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å¯èƒ½å‡ºé—®é¢˜
    
        public void update() {
            // ...
            count++;
        }
    }


ä¾‹3ï¼š

    @Aspect
    @Component
    public class MyAspect {//å•ä¾‹ï¼Œæˆå‘˜å˜é‡ä¼šå…±äº«
        // æ˜¯å¦å®‰å…¨ï¼Ÿno
        private long start = 0L;
    
        @Before("execution(* *(..))")
        public void before() {
            start = System.nanoTime();
        }
    
        @After("execution(* *(..))")
        public void after() {
            long end = System.nanoTime();
            System.out.println("cost time:" + (end-start));
        }
    }


4.Monitor
---------

### 4-1 Javaå¯¹è±¡å¤´

è¿™é‡Œä»¥32ä½è™šæ‹Ÿæœºä¸ºä¾‹ï¼š

æ™®é€šå¯¹è±¡ï¼š  
![](https://img-blog.csdnimg.cn/c18da565f20c4284b1fe8ed97e9b7350.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

æ•°ç»„å¯¹è±¡ï¼š

![](https://img-blog.csdnimg.cn/f03dda03f0d74817bea249bcbeda8bd9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

å…¶ä¸­Mark Word ç»“æ„ä¸ºï¼š

![](https://img-blog.csdnimg.cn/d20608df385a4029be067aa2b21d70f8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

64 ä½è™šæ‹Ÿæœº Mark Wordï¼š

![](https://img-blog.csdnimg.cn/88230d375dc64d958bb423153c339c17.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

### 4-2 åŸç†ä¹‹Monitor

Monitorè¢«ç¿»è¯‘ä¸º**ç›‘è§†å™¨**æˆ–**ç®¡ç¨‹**

**æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡**ï¼Œå¦‚æœä½¿ç”¨ **synchronized** ç»™å¯¹è±¡ä¸Šé”ï¼ˆ**é‡é‡çº§**ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ **Mark Word** ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ

Monitor ç»“æ„å¦‚ä¸‹ï¼š

![](https://img-blog.csdnimg.cn/img_convert/a1ab4ee5a45633c17591cd9fae7f58f1.png)

*   åˆšå¼€å§‹ Monitor ä¸­ Owner ä¸º null
*   å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2ï¼Œ**Monitorä¸­åªèƒ½æœ‰ä¸€ ä¸ª Owner**
*   åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ Thread-3ï¼ŒThread-4ï¼ŒThread-5 ä¹Ÿæ¥æ‰§è¡Œ synchronized(obj)ï¼Œå°±ä¼šè¿›å…¥ **EntryList** ï¼ˆè¿›å…¥**é˜»å¡çŠ¶æ€**ï¼ŒBLOCKED ï¼‰
*   Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶å**å”¤é†’** EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥**ç«äº‰é”**ï¼Œç«äº‰çš„æ—¶æ˜¯**éå…¬å¹³çš„**
*   å›¾ä¸­ **WaitSet** ä¸­çš„ Thread-0ï¼ŒThread-1 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®² wait-notify æ—¶ä¼šåˆ†æ

> æ³¨æ„ï¼š
>
> *   synchronized å¿…é¡»æ˜¯è¿›å…¥**åŒä¸€ä¸ªå¯¹è±¡**çš„ monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ
> *   ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™

5.SynchronizedåŸç†è¿›é˜¶
------------------

### 5-1 è½»é‡çº§é”

*   **è½»é‡çº§é”ä½¿ç”¨åœºæ™¯ï¼š**å½“ä¸€ä¸ªå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œä½†è®¿é—®çš„æ—¶é—´æ˜¯**é”™å¼€çš„ï¼ˆä¸å­˜åœ¨ç«äº‰ï¼‰**ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚
*   è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯ `synchronized`

è¿™é‡Œä¸¾ä¸ªæ —å­ï¼šå‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”

    static final Object obj = new Object();
    public static void method1() {
        synchronized( obj ) {
            // åŒæ­¥å— A
            method2();
        }
    }
    public static void method2() {
        synchronized( obj ) {
            // åŒæ­¥å— B
        }
    }


*   åˆ›å»º**é”è®°å½•**ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„**æ ˆå¸§**éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•å¯¹è±¡ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨**é”å®šå¯¹è±¡çš„mark word**ï¼ˆä¸å†ä¸€å¼€å§‹å°±ä½¿ç”¨Monitorï¼‰
    
    [![](https://img-blog.csdnimg.cn/img_convert/e59e2d9d66e8b06b242a918573e1eca2.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608144942.png)
    
*   è®©é”è®°å½•ä¸­çš„Object referenceæŒ‡å‘é”å¯¹è±¡ï¼ˆObjectï¼‰ï¼Œå¹¶å°è¯•ç”¨caså»æ›¿æ¢Objectä¸­çš„mark wordï¼Œå°†æ­¤mark wordæ”¾å…¥lock recordä¸­ä¿å­˜
    
    ![](https://img-blog.csdnimg.cn/img_convert/a71f4c42c1f9f1e3c27bd2e65d11b439.png)
    
*   å¦‚æœcasæ›¿æ¢æˆåŠŸï¼Œåˆ™å°†Objectçš„å¯¹è±¡å¤´æ›¿æ¢ä¸º**é”è®°å½•çš„åœ°å€**å’Œ**çŠ¶æ€ 00ï¼ˆè½»é‡çº§é”çŠ¶æ€ï¼‰**ï¼Œå¹¶ç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”
    
    ![](https://img-blog.csdnimg.cn/img_convert/9a2670aac23e6adb88a4b3db3afa1779.png)
    
*   å¦‚æœ cas å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š
    
    *   å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥**é”è†¨èƒ€**è¿‡ç¨‹
        
    *   å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº† **synchronized é”é‡å…¥**ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°
        
        ![](https://img-blog.csdnimg.cn/031af353af8347e8941f6a5174e41b1e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)
    
*   å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰**å–å€¼ä¸º null** çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ä¸€
    
    ![](https://img-blog.csdnimg.cn/488be60ae22c4a3da81389aa663c4439.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)
    
*   å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´
    
    *   æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ
    *   å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹

### 5-2 é”è†¨èƒ€

å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œ**å°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚**

*   å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”
    
    ![](https://img-blog.csdnimg.cn/img_convert/9d13c9a18c4ce34ccc30d8dbb55d4f2c.png)
    
*   è¿™æ—¶ Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹
    
    *   å³ä¸º Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œè®© Object æŒ‡å‘é‡é‡çº§é”åœ°å€
    *   ç„¶åè‡ªå·±è¿›å…¥ Monitor çš„ EntryList BLOCKED
    
    ![](https://img-blog.csdnimg.cn/img_convert/8e9c733310caa74cb7f31892dea094dd.png)
    
*   å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹
    

### 5-3 è‡ªæ—‹ä¼˜åŒ–

é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥**é¿å…é˜»å¡**

*   è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚
*   åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚
*   Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½

### 5-4 åå‘é”

è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡**é‡å…¥**ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚

Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ ID è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰

![](https://img-blog.csdnimg.cn/img_convert/1bcc6d6394b0eab119355563fb5d5cef.png)

**åå‘çŠ¶æ€**

*   Normalï¼šä¸€èˆ¬çŠ¶æ€ï¼Œæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œå‰é¢62ä½ä¿å­˜çš„æ˜¯å¯¹è±¡çš„ä¿¡æ¯ï¼Œ**æœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆæœªä½¿ç”¨ï¼š0ï¼‰**
*   Biasedï¼šåå‘çŠ¶æ€ï¼Œä½¿ç”¨åå‘é”ï¼Œå‰é¢54ä½ä¿å­˜çš„å½“å‰çº¿ç¨‹çš„IDï¼Œ**æœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆä½¿ç”¨ï¼š1ï¼‰**
*   Lightweightï¼šä½¿ç”¨è½»é‡çº§é”ï¼Œå‰62ä½ä¿å­˜çš„æ˜¯é”è®°å½•çš„æŒ‡é’ˆï¼Œ**æœ€åä¸¤ä½ä¸ºçŠ¶æ€ï¼ˆ00ï¼‰**
*   Heavyweightï¼šä½¿ç”¨é‡é‡çº§é”ï¼Œå‰62ä½ä¿å­˜çš„æ˜¯Monitorçš„åœ°å€æŒ‡é’ˆï¼Œ**åä¸¤ä½ä¸ºçŠ¶æ€(10)**

![](https://img-blog.csdnimg.cn/img_convert/461b804dda9e6ee0737faf0519ca295c.png)

*   å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œåœ¨åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯¹è±¡çš„Mark Wordåä¸‰ä½åº”è¯¥æ˜¯101
*   ä½†æ˜¯åå‘é”é»˜è®¤æ˜¯**æœ‰å»¶è¿Ÿ**çš„ï¼Œä¸ä¼šå†ç¨‹åºä¸€å¯åŠ¨å°±ç”Ÿæ•ˆï¼Œè€Œæ˜¯ä¼šåœ¨ç¨‹åºè¿è¡Œä¸€æ®µæ—¶é—´ï¼ˆå‡ ç§’ä¹‹åï¼‰ï¼Œæ‰ä¼šå¯¹åˆ›å»ºçš„å¯¹è±¡è®¾ç½®ä¸ºåå‘çŠ¶æ€
*   å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œå¯¹è±¡çš„Mark Wordåä¸‰ä½åº”è¯¥æ˜¯001

**æ’¤é”€åå‘**

ä»¥ä¸‹å‡ ç§æƒ…å†µä¼šä½¿å¯¹è±¡çš„åå‘é”å¤±æ•ˆ

*   è°ƒç”¨å¯¹è±¡çš„hashCodeæ–¹æ³•
*   å¤šä¸ªçº¿ç¨‹ä½¿ç”¨è¯¥å¯¹è±¡
*   **è°ƒç”¨äº†wait/notifyæ–¹æ³•**ï¼ˆè°ƒç”¨waitæ–¹æ³•ä¼šå¯¼è‡´é”è†¨èƒ€è€Œä½¿ç”¨**é‡é‡çº§é”**ï¼‰

**æ‰¹é‡é‡åå‘**

*   å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯çº¿ç¨‹é—´ä¸å­˜åœ¨ç«äº‰ï¼Œè¿™æ—¶åå‘T1çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘T2ã€‚é‡åå‘ä¼šé‡ç½®Thread ID
*   å½“æ’¤é”€è¶…è¿‡20æ¬¡åï¼ˆè¶…è¿‡é˜ˆå€¼ï¼‰ï¼ŒJVMä¼šè§‰å¾—æ˜¯ä¸æ˜¯åå‘é”™äº†ï¼Œè¿™æ—¶ä¼šåœ¨ç»™å¯¹è±¡åŠ é”æ—¶ï¼Œé‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹

**æ‰¹é‡æ’¤é”€**

å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯**æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„**

6.Wait/Notify
-------------

### 6-1 åŸç†

![](https://img-blog.csdnimg.cn/img_convert/69adb6bcc079c50ed5ed35644ab463a0.png)

*   Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ **wait** æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€
*   BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äº**é˜»å¡**çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡
*   BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’
*   WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ **notify** æˆ– **notifyAll** æ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥ EntryList é‡æ–°ç«äº‰

è¿™é‡Œé™„ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹é‡Œçš„ä¸€å¼ å›¾ï¼š

![](https://img-blog.csdnimg.cn/ff9f599606b4446e825fec18a868768b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

### 6-2 APIä»‹ç»

*   `wait()` è®©è¿›å…¥ object ç›‘è§†å™¨çš„çº¿ç¨‹åˆ° waitSet ç­‰å¾…
*   `notify()` åœ¨ object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’
*   `notifyAll()` è®© object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’
*   wait() æ–¹æ³•ä¼šé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œè¿›å…¥ WaitSet ç­‰å¾…åŒºï¼Œä»è€Œè®©å…¶ä»–çº¿ç¨‹å°±æœºä¼šè·å–å¯¹è±¡çš„é”ã€‚æ— é™åˆ¶ç­‰å¾…ï¼Œç›´åˆ° notify
*   ä¸ºæ­¢ `wait(long n)` æœ‰æ—¶é™çš„ç­‰å¾…, åˆ° n æ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢« notify

**æ³¨æ„ï¼šåªæœ‰å½“å¯¹è±¡è¢«é”ä»¥åï¼Œæ‰èƒ½è°ƒç”¨waitå’Œnotifyæ–¹æ³•**

ä¾‹å­ï¼š

    @Slf4j
    public class Test6 {
        final static Object lock = new Object();
    
        public static void main(String[] args) {
            new Thread(() -> {
                synchronized (lock) {
                    log.debug("æ‰§è¡Œ...");
                    try {
                        lock.wait();//è®©çº¿ç¨‹åœ¨lockä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    log.debug("å…¶ä»–ä»£ç ...");
                }
            }, "t1").start();
    
            new Thread(() -> {
                synchronized (lock) {
                    log.debug("æ‰§è¡Œ...");
                    try {
                        lock.wait();//è®©çº¿ç¨‹åœ¨lockä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    log.debug("å…¶ä»–ä»£ç ...");
                }
            }, "t2").start();
            Sleeper.sleep(2);
            log.debug("å”¤é†’ lock ä¸Šçš„çº¿ç¨‹");
            synchronized (lock) {
                lock.notify(); //å”¤é†’ lock ä¸Šçš„ä¸€ä¸ªçº¿ç¨‹
                //lock.notifyAll(); //å”¤é†’ lock ä¸Šæ‰€æœ‰ç­‰å¾…çº¿ç¨‹
            }
        }
    }
    //è¾“å‡º
    20:36:08 DEBUG [t1] (Test6.java:13) - æ‰§è¡Œ...
    20:36:08 DEBUG [t2] (Test6.java:25) - æ‰§è¡Œ...
    20:36:10 DEBUG [main] (Test6.java:35) - å”¤é†’ lock ä¸Šçš„çº¿ç¨‹
    20:36:10 DEBUG [t1] (Test6.java:19) - å…¶ä»–ä»£ç ...


### 6-3 wait/notify çš„æ­£ç¡®ä½¿ç”¨

å¼€å§‹ä¹‹å‰å…ˆçœ‹çœ‹ `sleep(long n)` å’Œ `wait(long n)` çš„åŒºåˆ« ï¼š

1.  sleep æ˜¯ **Thread** æ–¹æ³•ï¼Œè€Œ wait æ˜¯ **Object** çš„æ–¹æ³•
2.  sleep ä¸éœ€è¦å¼ºåˆ¶å’Œ synchronized é…åˆä½¿ç”¨ï¼Œä½† wait éœ€è¦å’Œ synchronized ä¸€èµ·ç”¨
3.  sleep åœ¨ç¡çœ çš„åŒæ—¶ï¼Œ**ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”**ï¼Œä½† wait åœ¨ç­‰å¾…çš„æ—¶å€™**ä¼šé‡Šæ”¾å¯¹è±¡é”**
4.  ä»–ä»¬çš„çŠ¶æ€éƒ½æ˜¯`TIMED_WAITING`

ä»¥ä¸‹éƒ¨åˆ†å»ºè®®å‚è€ƒï¼š[ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¯»åç¬”è®°-part4](https://blog.csdn.net/qq_45966440/article/details/119536541)

**ç­‰å¾…æ–¹**éµå¾ªå¦‚ä¸‹åŸåˆ™ï¼š

1.  è·å–å¯¹è±¡çš„é”
2.  å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆè°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œè¢«é€šçŸ¥åä»è¦æ£€æŸ¥æ¡ä»¶
3.  æ¡ä»¶æ»¡è¶³åˆ™æ‰§è¡Œå¯¹åº”çš„é€»è¾‘

å¯¹åº”ä¼ªä»£ç ï¼š

    synchronized(å¯¹è±¡){
        while(æ¡ä»¶ä¸æ»¡è¶³){
            å¯¹è±¡.wait();
        }
        å¯¹åº”çš„å¤„ç†é€»è¾‘
    }


**é€šçŸ¥æ–¹**éµå¾ªå¦‚ä¸‹åŸåˆ™ï¼š

1.  è·å¾—å¯¹è±¡çš„é”
2.  æ”¹å˜æ¡ä»¶
3.  é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨å¯¹è±¡ä¸Šçš„çº¿ç¨‹

å¯¹åº”ä¼ªä»£ç ï¼š

    synchronized(å¯¹è±¡){
        æ”¹å˜æ¡ä»¶
        å¯¹è±¡.notifyAll();
    }


7.Park/Unpark
-------------

### 7-1 åŸºæœ¬ä½¿ç”¨

`park/unpark`éƒ½æ˜¯ `LockSupport` ç±»ä¸­çš„æ–¹æ³•

    //æš‚åœçº¿ç¨‹è¿è¡Œ
    LockSupport.park;
    
    //æ¢å¤çº¿ç¨‹è¿è¡Œ
    LockSupport.unpark(thread);


å…ˆ park å† unparkï¼š

    @Slf4j
    public class Test24 {
        public static void main(String[] args) {
            Thread t1 = new Thread(() -> {
                log.debug("start...");
                Sleeper.sleep(1);
                log.debug("park...");
                //æš‚åœçº¿ç¨‹è¿è¡Œ
                LockSupport.park();
                log.debug("resume...");
            }, "t1");
            t1.start();
            Sleeper.sleep(2);
            log.debug("unpark...");
            //æ¢å¤çº¿ç¨‹è¿è¡Œ
            LockSupport.unpark(t1);
        }
    }
    13:11:08 DEBUG [t1] (Test24.java:12) - start...
    13:11:09 DEBUG [t1] (Test24.java:14) - park...
    13:11:10 DEBUG [main] (Test24.java:20) - unpark...
    13:11:10 DEBUG [t1] (Test24.java:16) - resume...


### 7-2 ç‰¹ç‚¹

ä¸ Object çš„ `wait/notify` ç›¸æ¯”ï¼š

*   waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ**Object Monitor**ä¸€èµ·ä½¿ç”¨ï¼Œè€Œparkï¼Œunparkä¸å¿…
*   parkï¼Œunpark æ˜¯ä»¥**çº¿ç¨‹ä¸ºå•ä½**æ¥**é˜»å¡**å’Œ**å”¤é†’**çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½**éšæœº**å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆç²¾ç¡®
*   park & unpark å¯ä»¥**å…ˆ unpark**ï¼Œè€Œ wait & notify ä¸èƒ½å…ˆ notify
*   **parkä¸ä¼šé‡Šæ”¾é”**ï¼Œè€Œwaitä¼šé‡Šæ”¾é”

### 7-3 åŸç†

**æ¯ä¸ªçº¿ç¨‹**éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„**Parkå¯¹è±¡**ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡`_counter`ï¼Œ`_cond`ï¼Œ`__mutex`ç»„æˆ

*   å…ˆè°ƒç”¨parkå†è°ƒç”¨unparkæ—¶
    
    *   å…ˆè°ƒç”¨park
        
        *   çº¿ç¨‹è¿è¡Œæ—¶ï¼Œä¼šå°†Parkå¯¹è±¡ä¸­çš„\_counterçš„å€¼è®¾ä¸º0ï¼›
        *   è°ƒç”¨parkæ—¶ï¼Œä¼šå…ˆæŸ¥çœ‹counterçš„å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œåˆ™å°†çº¿ç¨‹æ”¾å…¥é˜»å¡é˜Ÿåˆ—condä¸­
        *   æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­åï¼Œä¼šå†æ¬¡å°†counterè®¾ç½®ä¸º0
    *   ç„¶åè°ƒç”¨unpark
        
        *   è°ƒç”¨unparkæ–¹æ³•åï¼Œä¼šå°†counterçš„å€¼è®¾ç½®ä¸º1
            
        *   å»å”¤é†’é˜»å¡é˜Ÿåˆ—condä¸­çš„çº¿ç¨‹
            
        *   çº¿ç¨‹ç»§ç»­è¿è¡Œå¹¶å°†counterçš„å€¼è®¾ä¸º0
            
            [![](https://img-blog.csdnimg.cn/img_convert/ed29e96a02b44a7c11aa528d0e95b5e2.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145250.png)
            

[![](https://img-blog.csdnimg.cn/img_convert/20838a7f30e67c5b8a5255f20268512d.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145303.png)

*   å…ˆè°ƒç”¨unparkï¼Œå†è°ƒç”¨park
    *   è°ƒç”¨unpark
        *   ä¼šå°†counterè®¾ç½®ä¸º1ï¼ˆè¿è¡Œæ—¶0ï¼‰
    *   è°ƒç”¨parkæ–¹æ³•
        *   æŸ¥çœ‹counteræ˜¯å¦ä¸º0
        *   å› ä¸ºunparkå·²ç»æŠŠcounterè®¾ç½®ä¸º1ï¼Œæ‰€ä»¥æ­¤æ—¶å°†counterè®¾ç½®ä¸º0ï¼Œä½†ä¸æ”¾å…¥é˜»å¡é˜Ÿåˆ—condä¸­

[![](https://img-blog.csdnimg.cn/img_convert/0cd9b3ca85bafd1b320e2e23add1fe71.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145313.png)

8.é‡æ–°ç†è§£çº¿ç¨‹çŠ¶æ€è½¬æ¢
------------

![](https://img-blog.csdnimg.cn/img_convert/78c9360f2a367e24c99ca91430644ddc.png)

å‡è®¾æœ‰çº¿ç¨‹`Thread t`

**æƒ…å†µä¸€ï¼šNEW â€“> RUNNABLE**

*   å½“è°ƒç”¨äº†`t.start()`æ–¹æ³•æ—¶ï¼Œç”± NEW â€“> RUNNABLE

**æƒ…å†µäºŒï¼š RUNNABLE <â€“> WAITING**

*   å½“è°ƒç”¨äº†t çº¿ç¨‹ç”¨ synchronized(obj) è·å–äº†å¯¹è±¡é”å
    *   è°ƒç”¨ `obj.wait()` æ–¹æ³•æ—¶ï¼Œt çº¿ç¨‹ä» RUNNABLE â€“> WAITING
    *   è°ƒç”¨ `obj.notify()`ï¼Œ`obj.notifyAll()`ï¼Œ`t.interrupt()` æ—¶
        *   ç«äº‰é”æˆåŠŸï¼Œt çº¿ç¨‹ä» WAITING â€“> RUNNABLE
        *   ç«äº‰é”å¤±è´¥ï¼Œt çº¿ç¨‹ä» WAITING â€“> BLOCKED

**æƒ…å†µä¸‰ï¼šRUNNABLE <â€“> WAITING**

*   å½“å‰çº¿ç¨‹è°ƒç”¨ `t.join()` æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» RUNNABLE â€“> WAITING
    *   æ³¨æ„æ˜¯**å½“å‰çº¿ç¨‹**åœ¨t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…
*   t çº¿ç¨‹**è¿è¡Œç»“æŸ**ï¼Œæˆ–è°ƒç”¨äº†**å½“å‰çº¿ç¨‹**çš„ `interrupt()` æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» WAITING â€“> RUNNABLE

**æƒ…å†µå››ï¼š RUNNABLE <â€“> WAITING**

*   å½“å‰çº¿ç¨‹è°ƒç”¨ `LockSupport.park()` æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹ä» RUNNABLE â€“> WAITING
*   è°ƒç”¨ `LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)` æˆ–è°ƒç”¨äº†çº¿ç¨‹çš„ `interrupt()` ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» WAITING â€“> RUNNABLE

**æƒ…å†µäº”ï¼š RUNNABLE <â€“> TIMED\_WAITING**

t çº¿ç¨‹ç”¨ synchronized(obj) è·å–äº†å¯¹è±¡é”å

*   è°ƒç”¨ `obj.wait(long n)` æ–¹æ³•æ—¶ï¼Œt çº¿ç¨‹ä» RUNNABLE â€“> TIMED\_WAITING
*   t çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–è°ƒç”¨ `obj.notify()` ï¼Œ `obj.notifyAll()` ï¼Œ `t.interrupt()` æ—¶
    *   ç«äº‰é”æˆåŠŸï¼Œt çº¿ç¨‹ä» TIMED\_WAITING â€“> RUNNABLE
    *   ç«äº‰é”å¤±è´¥ï¼Œt çº¿ç¨‹ä» TIMED\_WAITING â€“> BLOCKED

**æƒ…å†µå…­ï¼šRUNNABLE <â€“> TIMED\_WAITING**

*   å½“å‰çº¿ç¨‹è°ƒç”¨ `t.join(long n)` æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» RUNNABLE â€“> TIMED\_WAITING
    *   æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…
*   å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–t çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„ `interrupt()` æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» TIMED\_WAITING â€“> RUNNABLE

**æƒ…å†µä¸ƒï¼šRUNNABLE <â€“> TIMED\_WAITING**

*   å½“å‰çº¿ç¨‹è°ƒç”¨ `Thread.sleep(long n)` ï¼Œå½“å‰çº¿ç¨‹ä» RUNNABLE â€“> TIMED\_WAITING
*   å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œå½“å‰çº¿ç¨‹ä» TIMED\_WAITING â€“> RUNNABLE

**æƒ…å†µå…«ï¼šRUNNABLE <â€“> TIMED\_WAITING**

*   å½“å‰çº¿ç¨‹è°ƒç”¨ `LockSupport.parkNanos(long nanos)` æˆ– `LockSupport.parkUntil(long millis)` æ—¶ï¼Œå½“å‰çº¿ ç¨‹ä» RUNNABLE â€“> TIMED\_WAITING
*   è°ƒç”¨ `LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)` æˆ–è°ƒç”¨äº†çº¿ç¨‹çš„ `interrupt()` ï¼Œæˆ–æ˜¯ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» TIMED\_WAITINGâ€“> RUNNABLE

**æƒ…å†µä¹ï¼šRUNNABLE <â€“> BLOCKED**

*   t çº¿ç¨‹ç”¨ `synchronized(obj)` è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœ**ç«äº‰å¤±è´¥**ï¼Œä» RUNNABLE â€“> BLOCKED
*   æŒ obj é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰ BLOCKED çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­ t çº¿ç¨‹ç«äº‰æˆåŠŸï¼Œä» BLOCKED â€“> RUNNABLE ï¼Œå…¶å®ƒ**å¤±è´¥**çš„çº¿ç¨‹ä»ç„¶ BLOCKED

**æƒ…å†µåï¼š RUNNABLE <â€“> TERMINATED**

å½“å‰çº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥ TERMINATED

* * *

è¿™é‡Œé™„ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ä¸€å¼ å›¾åšä¸€ä¸ªæ¦‚æ‹¬ï¼š

![](https://img-blog.csdnimg.cn/656706c3ffec4da68b65846e97b8b5bd.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1OTY2NDQw,size_16,color_FFFFFF,t_70)

9.å¤šæŠŠé”
-----

    class BigRoom {
        //é¢å¤–åˆ›å»ºå¯¹è±¡æ¥ä½œä¸ºé”
    	private final Object studyRoom = new Object();
    	private final Object bedRoom = new Object();
    }


**å°†é”çš„ç²’åº¦ç»†åˆ†**

*   å¥½å¤„ï¼šæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦
*   åå¤„ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”

10.æ´»è·ƒæ€§
------

### 10-1 æ­»é”

æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”

å¦‚ï¼š

*   t1çº¿ç¨‹è·å¾—Aå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å–Bå¯¹è±¡çš„é”
*   t2çº¿ç¨‹è·å¾—Bå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å–Aå¯¹è±¡çš„é”

æˆ‘ä»¬æ¥çœ‹ä¸ªæ­»é”çš„æ —å­ï¼š

    @Slf4j
    public class Test26 {
        public static void main(String[] args) {
            test1();
        }
    
        private static void test1() {
            Object A = new Object();
            Object B = new Object();
            Thread t1 = new Thread(() -> {
                synchronized (A) {
                    log.debug("lock A");
                    Sleeper.sleep(1);
                    synchronized (B) {
                        log.debug("lock B");
                        log.debug("æ“ä½œ...");
                    }
                }
            }, "t1");
            Thread t2 = new Thread(() -> {
                synchronized (B) {
                    log.debug("lock B");
                    Sleeper.sleep(1);
                    synchronized (A) {
                        log.debug("lock A");
                        log.debug("æ“ä½œ...");
                    }
                }
            }, "t2");
            t1.start();
            t2.start();
        }
    }


**æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶**ï¼š

1.  **äº’æ–¥æ¡ä»¶**ã€‚åªæœ‰å¯¹å¿…é¡»äº’æ–¥ä½¿ç”¨çš„èµ„æºçš„äº‰æŠ¢æ‰ä¼šå¯¼è‡´æ­»é”ï¼ˆå¦‚å“²å­¦å®¶çš„ç­·å­ã€æ‰“å°æœºè®¾å¤‡ï¼‰ã€‚åƒå†…å­˜ã€æ‰¬å£°å™¨è¿™æ ·å¯ä»¥åŒæ—¶è®©å¤šä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºæ˜¯ä¸ä¼šå¯¼è‡´æ­»é”çš„ï¼ˆå› ä¸ºè¿›ç¨‹ä¸ç”¨é˜»å¡ç­‰å¾…è¿™ç§èµ„æºï¼‰ã€‚
2.  **ä¸å‰¥å¤ºæ¡ä»¶**ã€‚è¿›ç¨‹æ‰€è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½ç”±å…¶ä»–è¿›ç¨‹å¼ºè¡Œå¤ºèµ°ï¼Œåªèƒ½ä¸»åŠ¨é‡Šæ”¾ã€‚
3.  **è¯·æ±‚å’Œä¿æŒæ¡ä»¶**ã€‚è¿›ç¨‹å·²ç»ä¿æŒäº†è‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œè¯¥èµ„æºåˆè¢«å…¶ä»–è¿›ç¨‹å æœ‰ï¼Œæ­¤æ—¶è¯·æ±‚è¿›ç¨‹è¢«é˜»å¡ï¼Œä½†åˆå¯¹è‡ªå·±å·²æœ‰çš„èµ„æºä¿æŒä¸æ”¾ã€‚
4.  **å¾ªç¯ç­‰å¾…æ¡ä»¶**ã€‚å­˜åœ¨ä¸€ç§è¿›ç¨‹èµ„æºçš„å¾ªç¯ç­‰å¾…é“¾ï¼Œé“¾ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹å·²è·å¾—çš„èµ„æºåŒæ—¶è¢«ä¸‹ä¸€ä¸ªè¿›ç¨‹æ‰€è¯·æ±‚ã€‚

å¦‚æœæƒ³è¦è¯¦ç»†äº†è§£æ­»é”ï¼Œå¯ä»¥å‚è€ƒ[æ“ä½œç³»ç»Ÿ-æ­»é”](https://blog.csdn.net/qq_45966440/article/details/119132209)

* * *

### 10-2 å®šä½æ­»é”

æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨ **jconsole**å·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨ **jps** å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ **jstack** å®šä½æ­»é”

*   `jps+jstack ThreadID`
    
    ![](https://img-blog.csdnimg.cn/298a7b72914744c8bc1b6e07bfb8d25a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)
    
*   `jconsole`
    
    ![](https://img-blog.csdnimg.cn/img_convert/359638cf867dbe8d03da37c3e19fefe3.png)
    
    ![](https://img-blog.csdnimg.cn/img_convert/e9f23bd07142b38d856fef84e6ded641.png)
    

### 10-3 å“²å­¦å®¶å°±é¤é—®é¢˜

![](https://img-blog.csdnimg.cn/img_convert/fe5db50be9adb3cc3462805aa88b8057.png)

ä»£ç æ¼”ç¤ºï¼š

    public class Test27 {
        public static void main(String[] args) {
            Chopstick c1 = new Chopstick("1");
            Chopstick c2 = new Chopstick("2");
            Chopstick c3 = new Chopstick("3");
            Chopstick c4 = new Chopstick("4");
            Chopstick c5 = new Chopstick("5");
            new Philosopher("è‹æ ¼æ‹‰åº•", c1, c2).start();
            new Philosopher("æŸæ‹‰å›¾", c2, c3).start();
            new Philosopher("äºšé‡Œå£«å¤šå¾·", c3, c4).start();
            new Philosopher("èµ«æ‹‰å…‹åˆ©ç‰¹", c4, c5).start();
            new Philosopher("é˜¿åŸºç±³å¾·", c5, c1).start();
        }
    }
    
    /**
     * ç­·å­ç±»
     */
    class Chopstick {
        String name;
    
        public Chopstick(String name) {
            this.name = name;
        }
    
        @Override
        public String toString() {
            return "ç­·å­{" + name + '}';
        }
    }
    
    /**
     * å“²å­¦å®¶ç±»
     */
    @Slf4j
    class Philosopher extends Thread {
        Chopstick left;
        Chopstick right;
    
        public Philosopher(String name, Chopstick left, Chopstick right) {
            super(name);
            this.left = left;
            this.right = right;
        }
    
        public void eat() {
            log.debug("eating...");
            Sleeper.sleep(1);
        }
    
        @Override
        public void run() {
            while (true) {
                while (true) {
                    // è·å¾—å·¦æ‰‹ç­·å­
                    synchronized (left) {
                        // è·å¾—å³æ‰‹ç­·å­
                        synchronized (right) {
                            // åƒé¥­
                            eat();
                        }
                        // æ”¾ä¸‹å³æ‰‹ç­·å­
                    }
                    // æ”¾ä¸‹å·¦æ‰‹ç­·å­
                }
            }
        }
    }
    //è¯¥ä»£ç ä¼šå‘ç”Ÿæ­»é”


### 10-4 æ´»é”

æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹**äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶**ï¼Œæœ€ååè°ä¹Ÿæ— æ³•ç»“æŸ

ä¸¾ä¸ªä¾‹å­ï¼š

    @Slf4j
    public class Test28 {
        static volatile int count = 10;
        static final Object lock = new Object();
    
        public static void main(String[] args) {
            new Thread(() -> {
                while (count > 0) {
                    Sleeper.sleep(0.2);
                    count--;
                    log.debug("count:{}", count);
                }
            }, "t1").start();
    
            new Thread(() -> {
                while (count < 20) {
                    Sleeper.sleep(0.2);
                    count++;
                    log.debug("count:{}", count);
                }
            }, "t2").start();
        }
    }
    //å¯ä»¥æ”¹å˜ä¸¤è€…ç¡çœ æ—¶é—´ï¼Œä½¿å…¶äº¤é”™ï¼Œé¿å…æ´»é”äº§ç”Ÿ


**æ­»é”ä¸æ´»é”çš„åŒºåˆ«**ï¼š

*   æ­»é”ï¼šæ˜¯å› ä¸ºçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹è±¡æƒ³è¦çš„é”ï¼Œå¹¶ä¸”éƒ½ä¸é‡Šæ”¾ï¼Œæœ€ååˆ°æ—¶**çº¿ç¨‹é˜»å¡**ï¼Œ**åœæ­¢è¿è¡Œ**çš„ç°è±¡ã€‚
*   æ´»é”ï¼šæ˜¯å› ä¸ºçº¿ç¨‹é—´ä¿®æ”¹äº†å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œè€Œå¯¼è‡´ä»£ç **ä¸€ç›´åœ¨è¿è¡Œ**ï¼Œå´ä¸€ç›´**è¿è¡Œä¸å®Œ**çš„ç°è±¡

### 10-5 é¥¥é¥¿

ä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸï¼Œè¿™ç§ç°è±¡å°±æ˜¯é¥¥é¥¿

11.ReentrantLock
----------------

### 11-1 ç‰¹ç‚¹+è¯­æ³•

`ReentrantLock`ç›¸å¯¹äº `synchronized` å®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š

*   å¯ä¸­æ–­
*   å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´
*   å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”
*   æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼ˆå…·æœ‰å¤šä¸ª**waitset**ï¼‰

ä¸ `synchronized` ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥

åŸºæœ¬è¯­æ³•ï¼š

    // è·å–é”
    reentrantLock.lock();
    try {
        // ä¸´ç•ŒåŒº
    } finally {
        // é‡Šæ”¾é”
        reentrantLock.unlock();
    }


### 11-2 å¯é‡å…¥

*   **å¯é‡å…¥**æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”
*   å¦‚æœæ˜¯**ä¸å¯é‡å…¥**é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½

é”é‡å…¥ä¾‹å­ï¼š

    @Slf4j
    public class Test29 {
        private static ReentrantLock lock = new ReentrantLock();
    
        public static void main(String[] args) {
            lock.lock();
            try {
                log.debug("enter main");
                m1();
            } finally {
                lock.unlock();
            }
        }
    
        public static void m1() {
            lock.lock();
            try {
                log.debug("enter m1");
                m2();
            } finally {
                lock.unlock();
            }
        }
    
        public static void m2() {
            lock.lock();
            try {
                log.debug("enter m2");
    
            } finally {
                lock.unlock();
            }
        }
    }
    //è¾“å‡º
    16:10:20 DEBUG [main] (Test29.java:13) - enter main
    16:10:20 DEBUG [main] (Test29.java:22) - enter m1
    16:10:20 DEBUG [main] (Test29.java:31) - enter m2


### 11-3 å¯æ‰“æ–­

å¦‚æœæŸä¸ªçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨å…¶interruptæ–¹æ³•è®©å…¶åœæ­¢é˜»å¡ï¼Œè·å¾—é”å¤±è´¥

    @Slf4j
    public class Test30 {
        private static ReentrantLock lock = new ReentrantLock();
    
        public static void main(String[] args) {
            Thread t1 = new Thread(() -> {
                try {
                    //å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±ä¼šè·å–lock å¯¹è±¡é”
                    //å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—,å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨interruptæ–¹æ³•æ‰“æ–­
                    log.debug("å°è¯•è·å–é”");
                    lock.lockInterruptibly();//å¯æ‰“æ–­é”ï¼å¿…é¡»ç”¨è¯¥æ–¹æ³•ï¼Œlock()ä¸èƒ½æ‰“æ–­
                } catch (InterruptedException e) {
                    e.printStackTrace();
                    log.debug("æ²¡è·å¾—é”,è¿”å›");//ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­
                    return;
                }
                try {
                    log.debug("è·å–åˆ°é”");
                } finally {
                    lock.unlock();
                }
            }, "t1");
            lock.lock();//ä¸»çº¿ç¨‹è·å¾—é”
            log.debug("è·å¾—äº†é”");
            t1.start();
            try {
                sleep(1);
                t1.interrupt();
                log.debug("æ‰§è¡Œæ‰“æ–­");
            } finally {
                lock.unlock();
            }
        }
    }
    16:24:33 DEBUG [t1] (Test30.java:15) - å°è¯•è·å–é”
    16:24:34 DEBUG [main] (Test30.java:31) - æ‰“æ–­t1
    16:24:34 DEBUG [t1] (Test30.java:19) - æ²¡è·å¾—é”,è¿”å›


### 11-4 é”è¶…æ—¶

*   ä½¿ç”¨`lock.tryLock()`æ–¹æ³•ä¼šè¿”å›è·å–é”æ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸåˆ™è¿”å›trueï¼Œåä¹‹åˆ™è¿”å›falseã€‚
*   å¹¶ä¸”`tryLock()`æ–¹æ³•å¯ä»¥**æŒ‡å®šç­‰å¾…æ—¶é—´**ï¼Œå‚æ•°ä¸ºï¼š`tryLock(long timeout, TimeUnit unit)`, å…¶ä¸­`timeout`ä¸ºæœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œ`TimeUnit`ä¸ºæ—¶é—´å•ä½

æ”¹è¿›ä¹‹å‰å“²å­¦å®¶å°±é¤çš„æ­»é”é—®é¢˜ï¼š

    @Override
    public void run() {
        while (true) {
            if (left.tryLock()) {
                try {
                    if(right.tryLock()){
                        try {
                            eat();
                        }finally {
                            right.unlock();
                        }
                    }
                } finally {
                    left.unlock();
                }
            }
        }
    }
    //éœ€è¦ç»§æ‰¿ReentrantLock
    class Chopstick extends ReentrantLock {
        String name;
    
        public Chopstick(String name) {
            this.name = name;
        }
    
        @Override
        public String toString() {
            return "ç­·å­{" + name + '}';
        }
    }


### 11-5 å…¬å¹³é”

åœ¨çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¿›å…¥é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œ**å…ˆè¿›å…¥**çš„ä¼šåœ¨é”è¢«é‡Šæ”¾å**å…ˆè·å¾—**é”ã€‚è¿™æ ·çš„è·å–æ–¹å¼å°±æ˜¯**å…¬å¹³**çš„ã€‚

é»˜è®¤æ˜¯ä¸å…¬å¹³é”ï¼Œéœ€è¦åœ¨åˆ›å»ºæ—¶æŒ‡å®šä¸ºå…¬å¹³é”ï¼š

    ReentrantLock lock = new ReentrantLock(true);


å…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œ**ä¼šé™ä½å¹¶å‘åº¦**

### 11-6 æ¡ä»¶å˜é‡

`synchronized` ä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯æˆ‘ä»¬è®²åŸç†æ—¶é‚£ä¸ª `waitSet` ä¼‘æ¯å®¤ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥waitSet ç­‰å¾…

`ReentrantLock` çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒ**å¤šä¸ª**æ¡ä»¶å˜é‡çš„ï¼Œè¿™å°±å¥½æ¯”

*   synchronized æ˜¯é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯
*   è€Œ ReentrantLock æ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çƒŸçš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤ é†’

ä½¿ç”¨æµç¨‹ï¼š

* await å‰éœ€è¦**è·å¾—é”**

* await æ‰§è¡Œåï¼Œ**ä¼šé‡Šæ”¾é”**ï¼Œè¿›å…¥ `conditionObject` ç­‰å¾…

* await çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰å–é‡æ–°ç«äº‰ lock é”

*   ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ

    ```java
    @Slf4j
    public class Test80 {
        static final Object room = new Object();
        static boolean hasCigarette = false;//æœ‰æ²¡æœ‰çƒŸ
        static boolean hasTakeout = false;
        static ReentrantLock ROOM = new ReentrantLock();
        static Condition waitCigaretteSet = ROOM.newCondition();
        static Condition waitTakeoutSet = ROOM.newCondition();
    
        public static void main(String[] args) {
            new Thread(() -> {
                ROOM.lock();
                try {
                    log.debug("æœ‰çƒŸæ²¡?[{}]", hasCigarette);
                    while (!hasCigarette) {
                        log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                        try {
                            waitCigaretteSet.await();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    log.debug("æœ‰çƒŸæ²¡?[{}]", hasCigarette);
                    if (hasCigarette) {
                        log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                    } else {
                        log.debug("æ²¡å¹²æˆæ´»");
                    }
                } finally {
                    ROOM.unlock();
                }
            }, "å°å—").start();
            new Thread(() -> {
                ROOM.lock();
                try {
                    log.debug("å¤–å–é€åˆ°æ²¡?[{}]", hasTakeout);
                    while (!hasTakeout) {
                        log.debug("æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼");
                        try {
                            waitTakeoutSet.await();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    log.debug("å¤–å–é€åˆ°æ²¡?[{}]", hasTakeout);
                    if (hasTakeout) {
                        log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                    } else {
                        log.debug("æ²¡å¹²æˆæ´»..");
                    }
                } finally {
                    ROOM.unlock();
                }
            }, "å°å¥³").start();
    
            Sleeper.sleep(1);
            new Thread(() -> {
                ROOM.lock();
                try {
                    hasTakeout = true;
                    waitTakeoutSet.signal();
                } finally {
                    ROOM.unlock();
                }
            }, "é€å¤–å–çš„").start();
            Sleeper.sleep(1);
            new Thread(() -> {
                ROOM.lock();
                try {
                    hasCigarette = true;
                    waitCigaretteSet.signal();
                } finally {
                    ROOM.unlock();
                }
            }, "é€çƒŸçš„").start();
        }
    }
    ```
    
    
    

4.å…±äº«æ¨¡å‹ä¹‹å†…å­˜
===============================================================================================================

æœ¬æ–‡ç« è§†é¢‘æŒ‡è·¯ğŸ‘‰[é»‘é©¬ç¨‹åºå‘˜-å¹¶å‘ç¼–ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd?from=search&seid=2997500517729436594&spm_id_from=333.337.0.0)

1.Javaå†…å­˜æ¨¡å‹
----------

JMM å³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†**ä¸»å­˜ï¼ˆå…±äº«å†…å­˜ï¼‰ã€å·¥ä½œå†…å­˜ï¼ˆçº¿ç¨‹ç§æœ‰ï¼‰** æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€ CPU å¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€ CPU æŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚

**JMM**ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

*   **åŸå­æ€§** - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“
*   **å¯è§æ€§** - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu ç¼“å­˜çš„å½±å“
*   **æœ‰åºæ€§** - ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu æŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“

2.å¯è§æ€§
-----

### 2-1 é€€ä¸å‡ºçš„å¾ªç¯

å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š

    static boolean run = true;
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(()->{
            while(run){
                // ....
            }
        });
        t.start();
        Thread.sleep(1000);
        run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥
    }


**ä¸ºä»€ä¹ˆæ— æ³•é€€å‡ºè¯¥å¾ªç¯**ï¼Ÿ

1.  åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»**ä¸»å†…å­˜**è¯»å–äº† run çš„å€¼åˆ°**å·¥ä½œå†…å­˜**ã€‚
    
    ![](https://img-blog.csdnimg.cn/2363b3cf0c8c4c34be89818c84e143dd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)
    
2.  å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»**ä¸»å†…å­˜**ä¸­è¯»å– run çš„å€¼ï¼Œ**JIT ç¼–è¯‘å™¨**ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„**é«˜é€Ÿç¼“å­˜**ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡
    
    ![](https://img-blog.csdnimg.cn/579c364e13474ea1b378f513b517300a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)
    
3.  1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼
    
    ![](https://img-blog.csdnimg.cn/3d3b0a4e64424dc88f6325133ba46ec8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)
    

**è§£å†³åŠæ³•**

*   ä½¿ç”¨ `volatile`ï¼ˆæ˜“å˜å…³é”®å­—ï¼‰
*   å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°**æˆå‘˜å˜é‡**å’Œ**é™æ€æˆå‘˜å˜é‡**ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯**ç›´æ¥æ“ä½œä¸»å­˜**

### 2-2 å¯è§æ€§vsåŸå­æ€§

å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯**å¯è§æ€§**ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹**volatileå˜é‡**çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œ ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨**ä¸€ä¸ªå†™**çº¿ç¨‹ï¼Œ**å¤šä¸ªè¯»**çº¿ç¨‹çš„æƒ…å†µ

> æ³¨æ„ï¼š
>
> *   `synchronized` è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„**åŸå­æ€§**ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„**å¯è§æ€§**ã€‚
>
> *   ä½†ç¼ºç‚¹æ˜¯ `synchronized` æ˜¯å±äº**é‡é‡çº§**æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½ã€‚
>
> *   å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ `System.out.println()` ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ°å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿ
>
>     è¿›å…¥`println`æºç ï¼Œå¯ä»¥çœ‹å‡ºåŠ äº†`synchronized`ï¼Œä¿è¯äº†æ¯æ¬¡`run`å˜é‡éƒ½ä¼šä»ä¸»å­˜ä¸­è·å–
>
>         public void println(int x) {
>             synchronized (this) {
>                 print(x);
>                 newLine();
>             }
>         }
>
> 

3.æœ‰åºæ€§
-----

### 3-1 è¯¡å¼‚çš„ç»“æœ

çœ‹ä¸‹é¢ä¸€ä¸ªæ —å­ï¼š

    int num = 0;
    boolean ready = false;
    // çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
    public void actor1(I_Result r) {
        if(ready) {
            r.r1 = num + num;
        } else {
            r.r1 = 1;
        }
    }
    // çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
    public void actor2(I_Result r) {
        num = 2;
        ready = true;
    }


â€‹    

çœ‹åˆ°è¿™é‡Œå¯èƒ½èªæ˜çš„å°ä¼™ä¼´ä¼šæƒ³åˆ°æœ‰ä¸‹é¢ä¸‰ç§æƒ…å†µï¼š

æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1

æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1

æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰

**ä½†å…¶å®è¿˜æœ‰å¯èƒ½ä¸º0å“¦ï¼** ğŸ˜²

æœ‰å¯èƒ½è¿˜æ˜¯ï¼šçº¿ç¨‹ 2 æ‰§è¡Œ ready=true ï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1 ï¼Œè¿›å…¥ifåˆ†æ”¯ï¼Œç›¸åŠ ä¸º0ï¼Œåœ¨åˆ‡å›çº¿ç¨‹ 2 æ‰§è¡Œ num=2

è¿™ç§ç°è±¡å°±æ˜¯æŒ‡ä»¤é‡æ’

### 3-2 è§£å†³æ–¹æ³•

`volatile` ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’

    @JCStressTest
    @Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
    @Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
    @State
    public class ConcurrencyTest {
        int num = 0;
        volatile boolean ready = false;//å¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’
        @Actor
        public void actor1(I_Result r) {
            if(ready) {
                r.r1 = num + num;
            } else {
                r.r1 = 1;
            }
        }
        @Actor
        public void actor2(I_Result r) {
            num = 2;
            ready = true;
        }
    }


### 3-3 æœ‰åºæ€§ç†è§£

åŒä¸€çº¿ç¨‹å†…ï¼ŒJVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œçœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼š

    static int i;
    static int j;
    // åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ
    i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
    j = ...;


å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œ æ—¢å¯ä»¥æ˜¯

    i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
    j = ...;


ä¹Ÿå¯ä»¥æ˜¯

    j = ...;
    i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ


è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸º**æŒ‡ä»¤é‡æ’**ï¼Œ**å¤šçº¿ç¨‹ä¸‹æŒ‡ä»¤é‡æ’ä¼šå½±å“æ­£ç¡®æ€§**

### 3-4 happens-before

**happens-before** è§„å®šäº†å¯¹å…±äº«å˜é‡å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯**å¯è§æ€§**ä¸**æœ‰åºæ€§**çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§

*   çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§
    
        static int x;
        static Object m = new Object();
        new Thread(()->{
            synchronized(m) {
                x = 10;
            }
        },"t1").start();
        new Thread(()->{
            synchronized(m) {
                System.out.println(x);
            }
        },"t2").start()
    
*   çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§
    
        volatile static int x;
        new Thread(()->{
            x = 10;
        },"t1").start();
        new Thread(()->{
            System.out.println(x);
        },"t2").start();
    
*   çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§
    
        static int x;
        x = 10;
        new Thread(()->{
            System.out.println(x);
        },"t2").start();
    
*   çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ `t1.isAlive()` æˆ– `t1.join()`ç­‰å¾…å®ƒç»“æŸï¼‰
    
        static int x;
        Thread t1 = new Thread(()->{
            x = 10;
        },"t1");
        t1.start();
        t1.join();
        System.out.println(x);
    
*   çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€š è¿‡`t2.interrupted` æˆ– `t2.isInterrupted`ï¼‰
    
        static int x;
        public static void main(String[] args) {
            Thread t2 = new Thread(()->{
                while(true) {
                    if(Thread.currentThread().isInterrupted()) {
                        System.out.println(x);//10
                        break;
                    }
                }
            },"t2");
            t2.start();
            new Thread(()->{
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                x = 10;
                t2.interrupt();
            },"t1").start();
            while(!t2.isInterrupted()) {
                Thread.yield();
            }
            System.out.println(x);//10
        }
    
*   å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§
    
*   å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ `x hb-> y` å¹¶ä¸” `y hb-> z` é‚£ä¹ˆæœ‰ `x hb-> z`
    
        volatile static int x;
        static int y;
        new Thread(()->{ 
            y = 10;
            x = 20;//å†™å±éšœï¼Œyä¹Ÿä¼šåŒæ­¥åˆ°ä¸»å­˜
        },"t1").start();
        new Thread(()->{
            // x=20 å¯¹ t2 å¯è§, åŒæ—¶ y=10 ä¹Ÿå¯¹ t2 å¯è§
            System.out.println(x); 
        },"t2").start();
    
    

> ä»¥ä¸Šå˜é‡éƒ½æ˜¯æŒ‡**å…±äº«å˜é‡**å³æˆå‘˜å˜é‡æˆ–é™æ€èµ„æºå˜é‡

4.volatile åŸç†
-------------

volatileçš„åº•å±‚å®ç°åŸç†æ˜¯**å†…å­˜å±éšœ**ï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰

*   å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥**å†™å±éšœ**
*   å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥**è¯»å±éšœ**

### 4-1 å¦‚ä½•ä¿è¯å¯è§æ€§

*   **å†™å±éšœ**ï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­
    
        public void actor2(I_Result r) {
            num = 2;
            ready = true; // ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ
            // å†™å±éšœ
        }
    
*   **è¯»å±éšœ**ï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æ–°æ•°æ®
    
        public void actor1(I_Result r) {
            // è¯»å±éšœ
            // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ
            if(ready) {
                r.r1 = num + num;
            } else {
                r.r1 = 1;
            }
        }
    
    
    [![](https://img-blog.csdnimg.cn/img_convert/5f3edd4038d319b60b284676a8f514ee.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145713.png)
    

### 4-2 å¦‚ä½•ä¿è¯æœ‰åºæ€§

*   **å†™å±éšœ**ä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å
    
        public void actor2(I_Result r) {
            num = 2;
            ready = true; // ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ
            // å†™å±éšœ
        }
    
*   **è¯»å±éšœ**ä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰
    
        public void actor1(I_Result r) {
            // è¯»å±éšœ
            // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ
            if(ready) {
                r.r1 = num + num;
            } else {
                r.r1 = 1;
            }
        }
    
    
    â€‹    
    
    ![](https://img-blog.csdnimg.cn/img_convert/989ddf56e97f1054b1f369873d945d11.png)
    

ä½†æ˜¯ï¼Œ**ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™**ï¼š

*   å†™å±éšœä»…ä»…æ˜¯ä¿è¯**æœ¬çº¿ç¨‹**ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹è¯»è·‘åˆ°å®ƒå‰é¢å»
*   æœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†**æœ¬çº¿ç¨‹å†…**ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº

![](https://img-blog.csdnimg.cn/957ecc95104b4efebbaf52ced0404513.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATEwuTEVCUk9O,size_20,color_FFFFFF,t_70,g_se,x_16)

### 4-3 double-checked locking é—®é¢˜

ä»¥è‘—åçš„ double-checked locking å•ä¾‹æ¨¡å¼ä¸ºä¾‹

    public class Singleton {
        private Singleton() {
        }
        private static Singleton INSTANCE = null;
        public static Singleton getInstance() {
            //å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„ synchronized ä»£ç å—,æé«˜æ€§èƒ½ï¼Œé˜²æ­¢æ¯æ¬¡éƒ½åŠ é”
            if (INSTANCE == null) {
                //å¯èƒ½ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨synchronized ä»£ç å—è¿˜æ²¡åˆ›å»ºå®Œå¯¹è±¡æ—¶ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹å·²ç»åˆ°äº†è¿™ä¸€æ­¥ï¼Œæ‰€ä»¥é‡Œé¢è¿˜éœ€è¦åŠ ä¸Šåˆ¤æ–­
                synchronized (Singleton.class) {
                    //ä¹Ÿè®¸æœ‰å…¶ä»–çº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡
                    if (INSTANCE == null) {
                        INSTANCE = new Singleton();
                    }
                }
            }
            return INSTANCE;
        }
    }


ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š

*   æ‡’æƒ°å®ä¾‹åŒ–
*   é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”
*   æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼šç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„

`INSTANCE = new Singleton()` å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š

    0: new #2 // class cn/itcast/jvm/t4/Singleton
    3: dup
    4: invokespecial #3 // Method "<init>":()V
    7: putstatic #4 // Field INSTANCE:Lcn/itcast/jvm/t4/Singleton;


å…¶ä¸­4 7 ä¸¤æ­¥é¡ºåºä¸æ˜¯å›ºå®šçš„ï¼Œä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆå°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™ INSTANCE å˜é‡åï¼Œå†æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1,t2 æŒ‰å¦‚ä¸‹æ—¶é—´é¡ºåºæ‰§è¡Œï¼š

    æ—¶é—´1 t1 çº¿ç¨‹æ‰§è¡Œåˆ° INSTANCE = new Singleton();
    æ—¶é—´2 t1 çº¿ç¨‹åˆ†é…ç©ºé—´ï¼Œä¸ºSingletonå¯¹è±¡ç”Ÿæˆäº†å¼•ç”¨åœ°å€ï¼ˆ0 å¤„ï¼‰
    æ—¶é—´3 t1 çº¿ç¨‹å°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™ INSTANCEï¼Œè¿™æ—¶ INSTANCE != nullï¼ˆ7 å¤„ï¼‰
    æ—¶é—´4 t2 çº¿ç¨‹è¿›å…¥getInstance() æ–¹æ³•ï¼Œå‘ç° INSTANCE != nullï¼ˆsynchronizedå—å¤–ï¼‰ï¼Œç›´æ¥
    è¿”å› INSTANCE
    æ—¶é—´5 t1 çº¿ç¨‹æ‰§è¡ŒSingletonçš„æ„é€ æ–¹æ³•ï¼ˆ4 å¤„ï¼‰


è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°† æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹

å¯¹ `INSTANCE` ä½¿ç”¨ **volatile** ä¿®é¥°å³å¯ï¼Œå¯ä»¥**ç¦ç”¨æŒ‡ä»¤é‡æ’**ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ ä¼šçœŸæ­£æœ‰æ•ˆ



5.å…±äº«æ¨¡å‹ä¹‹æ— é”
===============================================================================================================

æœ¬æ–‡ç« è§†é¢‘æŒ‡è·¯ğŸ‘‰[é»‘é©¬ç¨‹åºå‘˜-å¹¶å‘ç¼–ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd?from=search&seid=2997500517729436594&spm_id_from=333.337.0.0)

1.æ— é”è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜
------------

æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯ `account.withdraw` å–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ï¼š

    interface Account {
        // è·å–ä½™é¢
        Integer getBalance();
        // å–æ¬¾
        void withdraw(Integer amount);
        /**
     * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ
     * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
     */
        static void demo(Account account) {
            List<Thread> ts = new ArrayList<>();
            long start = System.nanoTime();
            for (int i = 0; i < 1000; i++) {
                ts.add(new Thread(() -> {
                    account.withdraw(10);
                }));
            }
            ts.forEach(Thread::start);
            ts.forEach(t -> {
                try {
                    t.join();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            });
            long end = System.nanoTime();
            System.out.println(account.getBalance() 
                               + " cost: " + (end-start)/1000_000 + " ms");
        }
    }


åŸæœ‰å®ç°å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

    class AccountUnsafe implements Account {
        private Integer balance;
    
        public AccountUnsafe(Integer balance) {
            this.balance = balance;
        }
    
        @Override
        public Integer getBalance() {
            return balance;
        }
    
        @Override
        public void withdraw(Integer amount) {
            this.balance -= amount;
        }
    }


æ‰§è¡Œæµ‹è¯•ä»£ç ï¼š

    public static void main(String[] args) {
        Account.demo(new AccountUnsafe(10000));
    }


æŸæ¬¡å¾—åˆ°çš„ç»“æœï¼š

    330 cost: 306 ms 


**è§£å†³åŠæ³•-é”**

é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»™ Account å¯¹è±¡åŠ é”ï¼š

    @Override
    public synchronized void withdraw(Integer amount) {
        balance -= amount;
    }


**è§£å†³æ€è·¯-æ— é”**

    class AccountCas implements Account {
       
        private AtomicInteger balance;
    
        public AccountCas(int balance) {
            this.balance = new AtomicInteger(balance);
        }
    
        @Override
        public Integer getBalance() {
            return balance.get();
        }
    
        @Override
        public void withdraw(Integer amount) {
            while (true) {
                int prev = balance.get();
                //è¦ä¿®æ”¹çš„ä½™é¢
                int next = prev - amount;
                //æŠŠnextåŒæ­¥åˆ°ä¸»å­˜ï¼Œå¦‚æœæˆåŠŸé€€å‡ºå¾ªç¯ï¼Œä¸æˆåŠŸè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†amountï¼Œæ­¤æ—¶éœ€è¦é‡æ–°å†™å…¥
                if (balance.compareAndSet(prev, next)) {
                    break;
                }
            }
            // å¯ä»¥ç®€åŒ–ä¸ºä¸‹é¢çš„æ–¹æ³•
            // balance.addAndGet(-1 * amount);
        }
    }


2.CAS ä¸ volatile
----------------

### 2-1 CAS

å‰é¢çœ‹åˆ°çš„ `AtomicInteger` çš„è§£å†³æ–¹æ³•ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

    public void withdraw(Integer amount) {
        while(true) {
            // éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
            while (true) {
                // æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000
                int prev = balance.get();
                // åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990
                int next = prev - amount;
                /*
                 compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼
                 - ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥
                 æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990
                 é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•
                 - ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ
                 */
                if (balance.compareAndSet(prev, next)) {
                    break;
                }
            }
        }
    }


å…¶ä¸­çš„å…³é”®æ˜¯ `compareAndSet`ï¼Œå®ƒçš„ç®€ç§°å°±æ˜¯ `CAS` ï¼ˆä¹Ÿæœ‰ `Compare And Swap` çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯**åŸå­æ“ä½œ**ã€‚

![](https://img-blog.csdnimg.cn/img_convert/969e0f863c36184f31d97e464aad79e7.png)

> æ³¨æ„ï¼š
>
> *   å…¶å® CAS çš„åº•å±‚æ˜¯ `lock cmpxchg` æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸ CPU å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯ã€æ¯”è¾ƒ-äº¤æ¢ã€‘çš„**åŸå­æ€§**ã€‚
> *   åœ¨å¤šæ ¸çŠ¶æ€ä¸‹ï¼ŒæŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè®©æ€»çº¿é”ä½ï¼Œå½“è¿™ä¸ªæ ¸æŠŠæ­¤æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå†å¼€å¯æ€»çº¿ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„å‡†ç¡®æ€§ï¼Œæ˜¯åŸå­çš„ã€‚

### 2-2 volatile

*   è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„**å¯è§æ€§**ï¼Œéœ€è¦ä½¿ç”¨ `volatile` ä¿®é¥°ã€‚
*   å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°**æˆå‘˜å˜é‡**å’Œ**é™æ€æˆå‘˜å˜é‡**ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°**ä¸»å­˜ä¸­è·å–** å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ `volatile` å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹ `volatile` å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚

> æ³¨æ„ï¼š
>
> `volatile` ä»…ä»…**ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§**ï¼Œè®©å…¶å®ƒçº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°æ–°å€¼ï¼Œä½†ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™é—®é¢˜ï¼ˆ**ä¸èƒ½ä¿è¯åŸå­æ€§**ï¼‰

**CAS å¿…é¡»å€ŸåŠ© volatile** æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœ

### 2-3 ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ— é”æ¯”ä½¿ç”¨åŠ é”çš„**æ•ˆç‡æ›´é«˜**

*   æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œ `synchronized` ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚
*   ä½†æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤– CPU çš„æ”¯æŒï¼ŒCPU åœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘é“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜æ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

### 2-4 CASç‰¹ç‚¹

ç»“åˆ `CAS` å’Œ `volatile` å¯ä»¥å®ç°**æ— é”å¹¶å‘**ï¼Œé€‚ç”¨äº**çº¿ç¨‹æ•°å°‘ã€å¤šæ ¸ CPU** çš„åœºæ™¯ä¸‹ã€‚

*   `CAS` æ˜¯åŸºäº**ä¹è§‚é”**çš„æ€æƒ³ï¼šä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘åƒäºç‚¹å†é‡è¯•å‘—ã€‚
*   `synchronized` æ˜¯åŸºäº**æ‚²è§‚é”**çš„æ€æƒ³ï¼šæ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚
*   CAS ä½“ç°çš„æ˜¯**æ— é”å¹¶å‘**ã€**æ— é˜»å¡å¹¶å‘**
    *   å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€
    *   ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“

3.åŸå­æ•´æ•°
------

**J.U.C** å¹¶å‘åŒ…æä¾›äº†ï¼š

*   `AtomicBoolean`
*   `AtomicInteger`
*   `AtomicLong`

ä»¥ `AtomicInteger` ä¸ºä¾‹ï¼š

    AtomicInteger i = new AtomicInteger(0);
    // è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++
    System.out.println(i.getAndIncrement());
    // è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i
    System.out.println(i.incrementAndGet());
    // è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i
    System.out.println(i.decrementAndGet());
    // è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--
    System.out.println(i.getAndDecrement());
    // è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰
    System.out.println(i.getAndAdd(5));
    // åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰
    System.out.println(i.addAndGet(-5));
    // è·å–å¹¶æ›´æ–°ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰
    // å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
    System.out.println(i.getAndUpdate(p -> p - 2));
    // æ›´æ–°å¹¶è·å–ï¼ˆi = -2, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = 0, è¿”å› 0ï¼‰
    // å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
    System.out.println(i.updateAndGet(p -> p + 2));
    // è·å–å¹¶è®¡ç®—ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 10, è¿”å› 0ï¼‰
    // å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
    // getAndUpdate å¦‚æœåœ¨ lambda ä¸­å¼•ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¦ä¿è¯è¯¥å±€éƒ¨å˜é‡æ˜¯ final çš„
    // getAndAccumulate å¯ä»¥é€šè¿‡ å‚æ•°1 æ¥å¼•ç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä½†å› ä¸ºå…¶ä¸åœ¨ lambda ä¸­å› æ­¤ä¸å¿…æ˜¯ final
    System.out.println(i.getAndAccumulate(10, (p, x) -> p + x));
    // è®¡ç®—å¹¶è·å–ï¼ˆi = 10, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 0, è¿”å› 0ï¼‰
    // å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
    System.out.println(i.accumulateAndGet(-10, (p, x) -> p + x));


4.åŸå­å¼•ç”¨
------

### 4-1 åŸå­å¼•ç”¨çš„ä½¿ç”¨

ä¸ºä»€ä¹ˆéœ€è¦åŸå­å¼•ç”¨ç±»å‹ï¼Ÿ

*   `AtomicReference`
*   `AtomicMarkableReference`
*   `AtomicStampedReference`

æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š

    public interface DecimalAccount {
        BigDecimal getBalance();
    
        void withdraw(BigDecimal amount);
    
        /**
    	 * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ    
         * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0
    	 */
        static void demo(DecimalAccountImpl account) {
            List<Thread> ts = new ArrayList<>();
            long start = System.nanoTime();
            for (int i = 0; i < 1000; i++) {
                ts.add(new Thread(() -> {
                    account.withdraw(BigDecimal.TEN);
                }));
            }
            ts.forEach(Thread::start);
            ts.forEach(t -> {
                try {
                    t.join();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            });
            long end = System.nanoTime();
            System.out.println(account.getBalance() + " cost: " + (end - start) / 1000_000 + " ms");
        }
    }
    
    class DecimalAccountImpl implements DecimalAccount {
        //åŸå­å¼•ç”¨ï¼Œæ³›å‹ç±»å‹ä¸ºå°æ•°ç±»å‹
        AtomicReference<BigDecimal> balance;
    
        public DecimalAccountImpl(BigDecimal balance) {
            this.balance = new AtomicReference<BigDecimal>(balance);
        }
    
        @Override
        public BigDecimal getBalance() {
            return balance.get();
        }
    
        @Override
        public void withdraw(BigDecimal amount) {
            while(true) {
                BigDecimal pre = balance.get();
                BigDecimal next = pre.subtract(amount);
                if(balance.compareAndSet(pre, next)) {
                    break;
                }
            }
        }
    
        public static void main(String[] args) {
            DecimalAccount.demo(new DecimalAccountImpl(new BigDecimal("10000")));
        }
    }


### 4-2 ABA é—®é¢˜åŠè§£å†³

**ABAé—®é¢˜**

å› ä¸ºCASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™ï¼Œæ£€æŸ¥å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†ã€‚ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨**ç‰ˆæœ¬å·**ã€‚åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ 1ï¼Œé‚£ä¹ˆAâ†’Bâ†’Aå°±ä¼šå˜æˆ1Aâ†’2Bâ†’3A

ä» Java 1.5å¼€å§‹ï¼ŒJDKçš„AtomicåŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±»`AtomicStampedReference`æ¥è§£å†³ABAé—®é¢˜ã€‚è¿™ä¸ªç±»çš„`compareAndSet`æ–¹æ³•çš„ä½œç”¨æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼

**AtomicStampedReference**

    @Slf4j
    public class Test3 {
        static AtomicStampedReference<String> ref = new AtomicStampedReference<>("A", 0);
    
        public static void main(String[] args) {
            log.debug("main start...");
            // è·å–å€¼ A
            String prev = ref.getReference();
            // è·å–ç‰ˆæœ¬å·
            int stamp = ref.getStamp();
            log.debug("ç‰ˆæœ¬ {}", stamp);
            // å¦‚æœä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”Ÿäº† ABA ç°è±¡
            other();
            sleep(1);
            // å°è¯•æ”¹ä¸º C
            log.debug("change A->C {}", ref.compareAndSet(prev, "C", stamp, stamp + 1));
    
        }
    
        private static void other() {
            ref.compareAndSet(ref.getReference(), "B", ref.getStamp(), ref.getStamp() + 1);
            ref.compareAndSet(ref.getReference(), "A", ref.getStamp(), ref.getStamp() + 1);
        }
    }
    22:48:31 DEBUG [main] (Test3.java:16) - main start...
    22:48:31 DEBUG [main] (Test3.java:21) - ç‰ˆæœ¬ 0
    22:48:32 DEBUG [main] (Test3.java:26) - change A->C false


`AtomicStampedReference` å¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š A -> B -> A -> C ï¼Œé€šè¿‡`AtomicStampedReference`ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚

ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ï¼Œæ‰€ä»¥å°±æœ‰äº† `AtomicMarkableReference`

**AtomicMarkableReference**

    class GarbageBag {
        String desc;
    
        public GarbageBag(String desc) {
            this.desc = desc;
        }
    
        public void setDesc(String desc) {
            this.desc = desc;
        }
    
        @Override
        public String toString() {
            return super.toString() + " " + desc;
        }
    }
    @Slf4j
    public class TestABAAtomicMarkableReference {
        public static void main(String[] args) throws InterruptedException {
            GarbageBag bag = new GarbageBag("è£…æ»¡äº†åƒåœ¾");
            // å‚æ•°2 mark å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºåƒåœ¾è¢‹æ»¡äº†
            AtomicMarkableReference<GarbageBag> ref = new AtomicMarkableReference<>(bag, true);
            log.debug("ä¸»çº¿ç¨‹ start...");
            GarbageBag prev = ref.getReference();
            log.debug(prev.toString());
            new Thread(() -> {
                log.debug("æ‰“æ‰«å«ç”Ÿçš„çº¿ç¨‹ start...");
                bag.setDesc("ç©ºåƒåœ¾è¢‹");
                while (!ref.compareAndSet(bag, bag, true, false)) {}
                log.debug(bag.toString());
            }).start();
            Thread.sleep(1000);
            log.debug("ä¸»çº¿ç¨‹æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ");
            boolean success = ref.compareAndSet(prev, new GarbageBag("ç©ºåƒåœ¾è¢‹"), true, false);
            log.debug("æ¢äº†ä¹ˆï¼Ÿ" + success);
            log.debug(ref.getReference().toString());
        }
    }
    
    22:50:57 DEBUG [main] (Test5.java:14) - start...
    22:50:57 DEBUG [main] (Test5.java:16) - xpp.day3.GarbageBag@ffa5d è£…æ»¡äº†åƒåœ¾
    22:50:57 DEBUG [ä¿æ´é˜¿å§¨] (Test5.java:18) - start...
    22:50:57 DEBUG [ä¿æ´é˜¿å§¨] (Test5.java:21) - xpp.day3.GarbageBag@ffa5d ç©ºåƒåœ¾è¢‹
    22:50:58 DEBUG [main] (Test5.java:24) - æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ
    22:50:58 DEBUG [main] (Test5.java:26) - æ¢äº†å—ï¼Ÿfalse
    22:50:58 DEBUG [main] (Test5.java:27) - xpp.day3.GarbageBag@ffa5d ç©ºåƒåœ¾è¢‹


5.åŸå­æ•°ç»„
------

*   `AtomicIntegerArray`
*   `AtomicLongArray`
*   `AtomicReferenceArray`

> æ³¨æ„ï¼š
>
> å¯¹**å‡½æ•°å¼æ¥å£**ä¸ç†Ÿæ‚‰çš„å°ä¼™ä¼´å¯ä»¥å‚è€ƒğŸ‘‰[Javaâ€”å‡½æ•°å¼æ¥å£](https://blog.csdn.net/qq_45966440/article/details/119100813)

    /**
     å‚æ•°1ï¼Œæä¾›æ•°ç»„ã€å¯ä»¥æ˜¯çº¿ç¨‹ä¸å®‰å…¨æ•°ç»„æˆ–çº¿ç¨‹å®‰å…¨æ•°ç»„
     å‚æ•°2ï¼Œè·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•
     å‚æ•°3ï¼Œè‡ªå¢æ–¹æ³•ï¼Œå›ä¼  array, index
     å‚æ•°4ï¼Œæ‰“å°æ•°ç»„çš„æ–¹æ³•
    */
    // supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰ ()->ç»“æœ
    // function å‡½æ•° ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ (å‚æ•°)->ç»“æœ , BiFunction (å‚æ•°1,å‚æ•°2)->ç»“æœ
    // consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡ç»“æœ (å‚æ•°)->void, BiConsumer (å‚æ•°1,å‚æ•°2)->
    private static <T> void demo(
        Supplier<T> arraySupplier,
        Function<T, Integer> lengthFun,
        BiConsumer<T, Integer> putConsumer,
        Consumer<T> printConsumer ) {
        List<Thread> ts = new ArrayList<>();
        T array = arraySupplier.get();
        int length = lengthFun.apply(array);
        for (int i = 0; i < length; i++) {
            // æ¯ä¸ªçº¿ç¨‹å¯¹æ•°ç»„ä½œ 10000 æ¬¡æ“ä½œ
            ts.add(new Thread(() -> {
                for (int j = 0; j < 10000; j++) {
                    putConsumer.accept(array, j%length);
                }
            }));
        }
        ts.forEach(t -> t.start()); // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }); // ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸ
        printConsumer.accept(array);
    }


**ä¸å®‰å…¨çš„æ•°ç»„**

    demo(
        ()->new int[10],
        (array)->array.length,
        (array, index) -> array[index]++,
        array-> System.out.println(Arrays.toString(array))
    );
    è¾“å‡ºï¼š
    [9870, 9862, 9774, 9697, 9683, 9678, 9679, 9668, 9680, 9698] 


**å®‰å…¨çš„æ•°ç»„**

    demo(
        ()-> new AtomicIntegerArray(10),
        (array) -> array.length(),
        (array, index) -> array.getAndIncrement(index),
        array -> System.out.println(array)
    );
    è¾“å‡ºï¼š
    [10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000] 


6.å­—æ®µæ›´æ–°å™¨
-------

*   `AtomicReferenceFieldUpdater` // åŸŸ å­—æ®µ
*   `AtomicIntegerFieldUpdater`
*   `AtomicLongFieldUpdater`

åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹**å¯¹è±¡çš„æŸä¸ªåŸŸ**ï¼ˆFieldï¼‰è¿›è¡Œ**åŸå­æ“ä½œ**ï¼Œåªèƒ½é…åˆ `volatile` ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸

    Exception in thread "main" java.lang.IllegalArgumentException: Must be volatile type


æ —å­1ï¼š

    public class Test5 {
        private volatile int field;
        public static void main(String[] args) {
            AtomicIntegerFieldUpdater fieldUpdater =AtomicIntegerFieldUpdater.newUpdater(Test5.class, "field");
            Test5 test5 = new Test5();
            fieldUpdater.compareAndSet(test5, 0, 10);
            // ä¿®æ”¹æˆåŠŸ field = 10
            System.out.println(test5.field);
            // ä¿®æ”¹æˆåŠŸ field = 20
            fieldUpdater.compareAndSet(test5, 10, 20);
            System.out.println(test5.field);
            // ä¿®æ”¹å¤±è´¥ field = 20
            fieldUpdater.compareAndSet(test5, 10, 30);
            System.out.println(test5.field);
        }
    }
    //è¾“å‡ºï¼š
    10
    20
    20


æ —å­2ï¼š

    public class Test7 {
        public static void main(String[] args) {
            Student student = new Student();
    		//å‚æ•°1ï¼š æŒæœ‰å±æ€§çš„ç±»
            //å‚æ•°2ï¼šè¢«æ›´æ–°çš„å±æ€§çš„class
            //å‚æ•°3ï¼šå±æ€§çš„åç§°
            AtomicReferenceFieldUpdater<Student, String> updater = AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, "name");
            updater.compareAndSet(student, null, "xpp");//æ›´æ–°æˆåŠŸ
            System.out.println(student);
            updater.compareAndSet(student, "xp", "mzz");//æ›´æ–°å¤±è´¥
            System.out.println(student);
        }
    }
    
    @ToString
    class Student {
        volatile String name;
    }


7.åŸå­ç´¯åŠ å™¨
-------

**ç´¯åŠ å™¨æ€§èƒ½æ¯”è¾ƒ**

    private static <T> void demo(Supplier<T> adderSupplier, Consumer<T> action) {
        T adder = adderSupplier.get();
        long start = System.nanoTime();
        List<Thread> ts = new ArrayList<>();
        // 4 ä¸ªçº¿ç¨‹ï¼Œæ¯äººç´¯åŠ  50 ä¸‡
        for (int i = 0; i < 40; i++) {
            ts.add(new Thread(() -> {
                for (int j = 0; j < 500000; j++) {
                    action.accept(adder);
                }
            }));
        }
        ts.forEach(t -> t.start());
        // ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸ
        ts.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        long end = System.nanoTime();
        System.out.println(adder + " cost:" + (end - start) / 1000_000);
    }


æ¯”è¾ƒ `AtomicLong` ä¸ `LongAdder`

    for (int i = 0; i < 5; i++) {
     demo(() -> new LongAdder(), adder -> adder.increment());
    }
    for (int i = 0; i < 5; i++) {
     demo(() -> new AtomicLong(), adder -> adder.getAndIncrement());
    }
    //è¾“å‡º
    1000000 cost:43 
    1000000 cost:9 
    1000000 cost:7 
    1000000 cost:7 
    1000000 cost:7 
    1000000 cost:31 
    1000000 cost:27 
    1000000 cost:28 
    1000000 cost:24 
    1000000 cost:22 


å¯ä»¥çœ‹å‡º`LongAdder`æ•ˆç‡æ›´é«˜

æ€§èƒ½æå‡çš„åŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æœ‰ç«äº‰æ—¶ï¼Œ**è®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒ**ï¼ŒTherad-0 ç´¯åŠ  Cell\[0\]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell\[1\]â€¦ æœ€åå°†ç»“æœæ±‡æ€»ã€‚è¿™æ ·å®ƒä»¬åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚

8.LongAdderè¯¦è§£
-------------

LongAdder ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸï¼š

    // ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–
    transient volatile Cell[] cells;
    // åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸ
    transient volatile long base;
    // åœ¨ cells åˆ›å»ºæˆ–æ‰©å®¹æ—¶, ç½®ä¸º 1, è¡¨ç¤ºåŠ é”
    transient volatile int cellsBusy;


### 8-1 cas é”

    // ä¸è¦ç”¨äºå®è·µï¼ï¼ï¼
    @Slf4j
    public class LockCas {
        //0 æ²¡åŠ é”
        //1 åŠ é”
        private AtomicInteger state = new AtomicInteger(0);
    
        public void lock() {
            while (true) {
                //å½“ä¸º0æ—¶ï¼ŒåŠ é”ï¼Œstateå˜ä¸º1ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹æƒ³è·å¾—é”å°±ä¼šä¸€ç›´å¾ªç¯cas
                if (state.compareAndSet(0, 1)) {
                    break;
                }
            }
        }
    
        public void unlock() {
            log.debug("unlock...");
            state.set(0);
        }
    
        public static void main(String[] args) {
            LockCas lock = new LockCas();
            new Thread(() -> {
                log.debug("begin...");
                lock.lock();
                System.out.println(lock.state);
                try {
                    log.debug("lock...");
                    Sleeper.sleep(1);
                } finally {
                    lock.unlock();
                }
            }).start();
            new Thread(() -> {
                log.debug("begin...");
                lock.lock();
                try {
                    log.debug("lock...");
                } finally {
                    lock.unlock();
                }
            }).start();
    
        }
    }
    17:11:26 DEBUG [Thread-1] (LockCas.java:42) - begin...
    17:11:26 DEBUG [Thread-0] (LockCas.java:35) - lock...
    17:11:27 DEBUG [Thread-0] (LockCas.java:24) - unlock...
    17:11:27 DEBUG [Thread-1] (LockCas.java:45) - lock...
    17:11:27 DEBUG [Thread-1] (LockCas.java:24) - unlock...


### 8-2 åŸç†ä¹‹ä¼ªå…±äº«

    // é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«
    @sun.misc.Contended
        static final class Cell {
            volatile long value;
            Cell(long x) { value = x; }
    
            // æœ€é‡è¦çš„æ–¹æ³•, ç”¨æ¥ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼
            final boolean cas(long prev, long next) {
                return UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);
            }
            // çœç•¥ä¸é‡è¦ä»£ç 
        }


å¾—ä»ç¼“å­˜è¯´èµ·ï¼Œç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦æ¯”è¾ƒ

![](https://img-blog.csdnimg.cn/img_convert/9d3df3ad5311a92ecf235ccf78584ca3.png)

![](https://img-blog.csdnimg.cn/img_convert/b4d95b0315026ad343cda2dd2d2f3c2a.png)

*   å› ä¸º CPU ä¸ å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³**ç¼“å­˜**æ¥æå‡æ•ˆç‡ã€‚
*   è€Œç¼“å­˜ä»¥**ç¼“å­˜è¡Œ**ä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰
*   ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆ**æ•°æ®å‰¯æœ¬**çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­
*   CPU è¦ä¿è¯**æ•°æ®çš„ä¸€è‡´æ€§**ï¼Œå¦‚æœæŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ

![](https://img-blog.csdnimg.cn/img_convert/56de3a77bb6f96ba480f622083864c36.png)

å› ä¸º Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œå›  æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼š

*   Core-0 è¦ä¿®æ”¹ Cell\[0\]
*   Core-1 è¦ä¿®æ”¹ Cell\[1\]

æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹ Core çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚ Core-0 ä¸­Cell\[0\]=6000, Cell\[1\]=8000 è¦ç´¯åŠ  Cell\[0\]=6001, Cell\[1\]=8000 ï¼Œè¿™æ—¶ä¼šè®© Core-1 çš„ç¼“å­˜è¡Œå¤±æ•ˆ

`@sun.misc.Contended` ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„**å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ padding**ï¼ˆç©ºç™½ï¼‰ï¼Œä»è€Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶**å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œ**ï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ

![](https://img-blog.csdnimg.cn/img_convert/4f0aefac3f7bfaece8703efa77e342fa.png)

**ç´¯åŠ ä¸»è¦è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•**

    public void add(long x) {
        // as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„
        // b ä¸ºåŸºç¡€å€¼
        // x ä¸ºç´¯åŠ å€¼
        Cell[] as; long b, v; int m; Cell a;
        // è¿›å…¥ if çš„ä¸¤ä¸ªæ¡ä»¶
        // 1. as æœ‰å€¼, è¡¨ç¤ºå·²ç»å‘ç”Ÿè¿‡ç«äº‰, è¿›å…¥ if
        // 2. cas ç»™ base ç´¯åŠ æ—¶å¤±è´¥äº†, è¡¨ç¤º base å‘ç”Ÿäº†ç«äº‰, è¿›å…¥ if
        if ((as = cells) != null || !casBase(b = base, b + x)) {
            // uncontended è¡¨ç¤º cell æ²¡æœ‰ç«äº‰
            boolean uncontended = true;
            if (
                // as è¿˜æ²¡æœ‰åˆ›å»º
                as == null || (m = as.length - 1) < 0 ||
                // å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell è¿˜æ²¡æœ‰
                (a = as[getProbe() & m]) == null ||
                // cas ç»™å½“å‰çº¿ç¨‹çš„ cell ç´¯åŠ å¤±è´¥ uncontended=false ( a ä¸ºå½“å‰çº¿ç¨‹çš„ cell )
                !(uncontended = a.cas(v = a.value, v + x))
            ) {
                // è¿›å…¥ cell æ•°ç»„åˆ›å»ºã€cell åˆ›å»ºçš„æµç¨‹
                longAccumulate(x, null, uncontended);
            }
        }
    }


**ç´¯åŠ æµç¨‹å›¾**

![](https://img-blog.csdnimg.cn/img_convert/ce399f7bd72da53a22f6fbaba896dcc1.png)

9.Unsafe
--------

### 9-1 æ¦‚è¿°

Unsafe å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡**åå°„**è·å¾—

    public class TestUnsafe {
        public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
            Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
            theUnsafe.setAccessible(true);
            Unsafe unsafe = (Unsafe) theUnsafe.get(null);
            System.out.println(unsafe);
        }
    }


### 9-2 Unsafe CAS æ“ä½œ

```java
public class TestUnsafe {
    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
        Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafe.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafe.get(null);

        System.out.println(unsafe);

        //1.è·å–åŸŸçš„åç§»åœ°å€
        long idOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("id"));
        long nameOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField("name"));
        //2.æ‰§è¡Œ cas æ“ä½œ
        Teacher t = new Teacher();
        unsafe.compareAndSwapInt(t, idOffset, 0, 2);
        unsafe.compareAndSwapObject(t, nameOffset, null, "xpp");
        System.out.println(t.getId() + "---->" + t.getName());
    }
}

@Data
class Teacher {
    volatile int id;
    volatile String name;
}
//è¾“å‡º
sun.misc.Unsafe@103dbd3
2---->xpp
```



ReentrantLockåŸç†
===============

1.éå…¬å¹³é”å®ç°åŸç†å…ˆä»æ„é€ å™¨å¼€å§‹çœ‹ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”å®ç°ï¼š
----------

    //é»˜è®¤éå…¬å¹³é”
    public ReentrantLock() {
        sync = new NonfairSync();
    }


`NonfairSync` ç»§æ‰¿è‡ª `AQS`ã€‚

æ²¡æœ‰ç«äº‰æ—¶ï¼š

![](https://img-blog.csdnimg.cn/img_convert/2cf7fd758f1a8607f4cd120bbf83e31c.png)

ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶ï¼š

![](https://img-blog.csdnimg.cn/img_convert/3dee414f14963efbcbfab6383d77371b.png)

Thread-1 æ‰§è¡Œäº†ï¼š

1.  `CAS` å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥
2.  è¿›å…¥ `tryAcquire` é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥
3.  æ¥ä¸‹æ¥è¿›å…¥ `addWaiter` é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—
    *   å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ `0` ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€
    *   Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„
    *   å…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹

![](https://img-blog.csdnimg.cn/img_convert/c77210a258a2c320377c36601121c1f7.png)

å½“å‰çº¿ç¨‹è¿›å…¥ `acquireQueued` é€»è¾‘ï¼š

1.  acquireQueued ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ `park` é˜»å¡
    
2.  å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€ headï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡ `tryAcquire` å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥
    
3.  è¿›å…¥ `shouldParkAfterFailedAcquire` é€»è¾‘ï¼Œå°†å‰é©± nodeï¼Œå³ head çš„ waitStatus æ”¹ä¸º -1ï¼Œè¿™æ¬¡è¿”å› false
    
    ![](https://img-blog.csdnimg.cn/img_convert/a7006d0df6567fe26ecdd28421c04ee3.png)
    
4.  shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥
    
5.  å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ `-1`ï¼Œè¿™æ¬¡è¿”å› true
    
6.  è¿›å…¥ `parkAndCheckInterrupt`ï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰
    

![](https://img-blog.csdnimg.cn/img_convert/87a1d504551f8ad184364426dc484d85.png)

å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­ï¼š

![](https://img-blog.csdnimg.cn/img_convert/43cdaaeb2ddad517242b7a427c608000.png)

Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ `tryRelease` æµç¨‹ï¼Œå¦‚æœæˆåŠŸï¼š

*   è®¾ç½® `exclusiveOwnerThread` ä¸º null
*   state = 0

![](https://img-blog.csdnimg.cn/img_convert/879d3c95b3afd5deb0c28a12770f27b1.png)

å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ `waitStatus = -1`ï¼Œè¿›å…¥ `unparkSuccessor` æµç¨‹ã€‚

æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦» head æœ€è¿‘çš„ä¸€ä¸ª Nodeï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œ`unpark` æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1

å›åˆ° Thread-1 çš„ `acquireQueued` æµç¨‹

![](https://img-blog.csdnimg.cn/img_convert/2f198b0f7c77b4d2fa7a94ffada920f5.png)

å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®ï¼š

*   exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1
*   head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node æ¸…ç©º Thread
*   åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶

å¦‚æœè¿™æ—¶å€™æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†

![](https://img-blog.csdnimg.cn/img_convert/9a7b9ee4c8658089c07a2df263ace5f2.png)

å¦‚æœä¸å·§åˆè¢« Thread-4 å äº†å…ˆ

*   Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1
*   Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡

2.å¯é‡å…¥åŸç†
-------

è¿™é‡Œä»¥éå…¬å¹³é”ä¸ºä¾‹ï¼š

è·å–é”ï¼š

    // ReentrantLock.Sync.nonfairTryAcquire()
    final boolean nonfairTryAcquire(int acquires) {
        //è·å–å½“å‰çº¿ç¨‹
        final Thread current = Thread.currentThread();
        //è·å–çŠ¶æ€å€¼
        int c = getState();
        if (c == 0) {
            //å¦‚æœçŠ¶æ€å˜é‡ä¸º0ï¼Œå†æ¬¡å°è¯•CASæ›´æ–°çŠ¶æ€å˜é‡çš„å€¼
            //ç›¸å¯¹äºå…¬å¹³é”æ¨¡å¼å°‘äº†!hasQueuedPredecessors()æ¡ä»¶
            if (compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(current);
                return true;
            }
        }
        // å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥
        else if (current == getExclusiveOwnerThread()) {
            //state++
            int nextc = c + acquires;
            if (nextc < 0) // overflow
                throw new Error("Maximum lock count exceeded");
            setState(nextc);
            return true;
        }
        return false;
    }


é‡Šæ”¾é”ï¼š

    //ReentrantLock.Sync.tryRelease
    protected final boolean tryRelease(int releases) {
        //state--
        int c = getState() - releases;
        // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯å æœ‰ç€é”çš„çº¿ç¨‹ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (Thread.currentThread() != getExclusiveOwnerThread())
            throw new IllegalMonitorStateException();
        boolean free = false;
        //å¦‚æœçŠ¶æ€å˜é‡çš„å€¼ä¸º0äº†ï¼Œè¯´æ˜å®Œå…¨é‡Šæ”¾äº†é”
        //è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé‡å…¥é”è°ƒç”¨äº†å¤šå°‘æ¬¡lock()å°±è¦è°ƒç”¨å¤šå°‘æ¬¡unlock()çš„åŸå› 
        //å¦‚æœä¸è¿™æ ·åšï¼Œä¼šå¯¼è‡´é”ä¸ä¼šå®Œå…¨é‡Šæ”¾ï¼Œåˆ«çš„çº¿ç¨‹æ°¸è¿œæ— æ³•è·å–åˆ°é”
        if (c == 0) {
            free = true;
            // æ¸…ç©ºå æœ‰çº¿ç¨‹
            setExclusiveOwnerThread(null);
        }
        //è®¾ç½®çŠ¶æ€å˜é‡çš„å€¼
        setState(c);
        return free;
    }


å¯ä»¥çœ‹å‡ºæºç ä¸­é€šè¿‡`state`å˜é‡çš„è®¡æ•°æ¥å®ç°å¯é‡å…¥ï¼Œåªæœ‰å½“`state==0`æ—¶æ‰è¯´æ˜å·²ç»ä¸æŒæœ‰é”ã€‚

3.å¯æ‰“æ–­åŸç†
-------

### 3.1 ä¸å¯æ‰“æ–­æ¨¡å¼

åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ [AQS](https://so.csdn.net/so/search?q=AQS&spm=1001.2101.3001.7020) é˜Ÿåˆ—ä¸­ï¼Œä¸€ç›´è¦ç­‰åˆ°è·å¾—é”åæ–¹èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­äº†ã€‚

    //AbstractQueuedSynchronizer.acquireQueued()
    final boolean acquireQueued(final Node node, int arg) {
        //å¤±è´¥æ ‡è®°
        boolean failed = true;
        try {
            //ä¸­æ–­æ ‡è®°
            boolean interrupted = false;
            //è‡ªæ—‹
            for (;;) {
                //å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹
                final Node p = node.predecessor();
                //å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ä¸ºheadèŠ‚ç‚¹ï¼Œåˆ™è¯´æ˜è½®åˆ°è‡ªå·±è·å–é”äº†
                //è°ƒç”¨ReentrantLock.FairSync.tryAcquire()æ–¹æ³•å†æ¬¡å°è¯•è·å–é”
                if (p == head && tryAcquire(arg)) {
                    //å°è¯•è·å–é”æˆåŠŸ
                    //è¿™é‡ŒåŒæ—¶åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨CASæ›´æ–°
                    //æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å¤´èŠ‚ç‚¹
                    setHead(node);
                    //å¹¶æŠŠä¸Šä¸€ä¸ªèŠ‚ç‚¹ä»é“¾è¡¨ä¸­åˆ é™¤
                    p.next = null; // help GC
                    //æ ‡è®°ä¸ºæœªå¤±è´¥
                    failed = false;
                    //è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€
                    return interrupted;
                }
                //æ˜¯å¦éœ€è¦é˜»å¡
                if (shouldParkAfterFailedAcquire(p, node) &&
                    //çœŸæ­£é˜»å¡çš„æ–¹æ³•
                    parkAndCheckInterrupt())
                    // å¦‚æœæ˜¯å› ä¸º interrupt è¢«å”¤é†’, è¿”å›æ‰“æ–­çŠ¶æ€ä¸º true
                    interrupted = true;
            }
        } finally {
            //å¦‚æœå¤±è´¥äº†
            if (failed)
                cancelAcquire(node);
        }
    }


    //AbstractQueuedSynchronizer.parkAndCheckInterrupt()
    private final boolean parkAndCheckInterrupt() {
        //å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ
        LockSupport.park(this);
        //interrupted ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°
        //æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œä¸‹æ¬¡parkå°±ä¸ä¼šå—åˆ°å½±å“
        return Thread.interrupted();
    }


    public final void acquire(int arg) {
        if (
            !tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)
        ) {
            // å¦‚æœæ‰“æ–­çŠ¶æ€ä¸º trueï¼ŒacquireQueuedæ–¹æ³•å°±ä¼šè¿”å›æˆåŠŸã€‚å°±ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•
            selfInterrupt();
        }
    }
    static void selfInterrupt() {
        // é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­
        Thread.currentThread().interrupt();
    }


### 3.2 å¯æ‰“æ–­æ¨¡å¼

ä¸ä¸å¯æ‰“æ–­æ¨¡å¼ä¸åŒçš„æ˜¯ï¼Œå½“è¢«`interrupt`æ—¶æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸çš„ï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œforå¾ªç¯ã€‚æ­¤æ—¶ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥åœæ­¢ç­‰å¾…ã€‚

    //ReentrantLock.lockInterruptibly()
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }
    //AbstractQueuedSynchronizer.acquireInterruptibly(int arg)
    public final void acquireInterruptibly(int arg)
            throws InterruptedException {
        if (Thread.interrupted())
            throw new InterruptedException();
        //å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”ï¼Œè¿›å…¥doAcquireInterruptiblyæ–¹æ³•
        if (!tryAcquire(arg))
            doAcquireInterruptibly(arg);
    }
    private void doAcquireInterruptibly(int arg)
            throws InterruptedException {
        final Node node = addWaiter(Node.EXCLUSIVE);
        boolean failed = true;
        try {
            for (; ; ) {
                final Node p = node.predecessor();
                if (p == head && tryAcquire(arg)) {
                    setHead(node);
                    p.next = null; // help GC
                    failed = false;
                    return;
                }
                if (shouldParkAfterFailedAcquire(p, node) &&
                        parkAndCheckInterrupt())
                    //åœ¨parkè¿‡ç¨‹ä¸­å¦‚æœè¢«interruptä¼šè¿›å…¥è¿™é‡Œ
                    //è¿™æ—¶å€™æŠ›å‡ºä¸€æ¬¡ï¼Œè€Œä¸ä¼šå†æ¬¡è¿›å…¥forå¾ªç¯
                    throw new InterruptedException();
            }
        } finally {
            if (failed)
                cancelAcquire(node);
        }
    }


4.å…¬å¹³é”å®ç°åŸç†
---------

    //ReentrantLock.FairSync.lock()
    final void lock() {
        //è°ƒç”¨AQSçš„acquire()æ–¹æ³•è·å–é”
        //æ³¨æ„ï¼Œè¿™é‡Œä¼ çš„å€¼ä¸º1
        acquire(1);
    }


    //AbstractQueuedSynchronizer.acquire()
    public final void acquire(int arg) {
        //å…ˆå°è¯•åŠ é”
        //å¦‚æœå¤±è´¥äº†ï¼Œå°±æ’é˜Ÿ
        if (!tryAcquire(arg) &&
                //æ³¨æ„addWaiter()è¿™é‡Œä¼ å…¥çš„èŠ‚ç‚¹æ¨¡å¼ä¸ºâ€œç‹¬å æ¨¡å¼â€
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }


    //ReentrantLock.FairSync.tryAcquire()
    //ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•çš„å®ç°
    protected final boolean tryAcquire(int acquires) {
        //è·å–å½“å‰çº¿ç¨‹
        final Thread current = Thread.currentThread();
        //è·å–å½“å‰çŠ¶æ€å˜é‡çš„å€¼
        int c = getState();
        //å¦‚æœä¸º0ï¼Œè¯´æ˜ç°åœ¨è¿˜æ²¡æœ‰äººå æœ‰é”
        if (c == 0) {
            //å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰æ‰å»ç«äº‰
            //å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ’é˜Ÿï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°è¯•æ›´æ–°stateçš„å€¼ä¸º1
            //å¦‚æœæˆåŠŸäº†ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹è·å–äº†é”
            if (!hasQueuedPredecessors() &&
                compareAndSetState(0, acquires)) {
                //å½“å‰çº¿ç¨‹è·å–äº†é”ï¼ŒæŠŠè‡ªå·±è®¾ç½®åˆ°exclusiveOwnerThreadä¸­
                //exclusiveOwnerThreadæ˜¯AQSçš„çˆ¶ç±»AbstractOwnableSynchronizerä¸­æä¾›çš„å˜é‡
                setExclusiveOwnerThread(current);
                //è¿”å›trueï¼Œè¯´æ˜æˆåŠŸè·å¾—äº†é”
                return true;
            }
        }
        //å¦‚æœå½“å‰çº¿ç¨‹æœ¬èº«å°±å æœ‰é”ï¼Œç°åœ¨åˆå°è¯•è·å–é”
        //é‚£ä¹ˆï¼Œç›´æ¥è®©ä»–è·å–é”ï¼Œå¹¶è¿”å›true
        else if (current == getExclusiveOwnerThread()) {
            //çŠ¶æ€å˜é‡stateçš„å€¼åŠ ä¸€
            int nextc = c + acquires;
            //å¦‚æœå‘é€ä¸€å‡ºï¼Œåˆ™æŠ¥é”™
            if (nextc < 0)
                throw new Error("Maximum lock count exceeded");
            //è¿™é‡Œä¸ºä»€ä¹ˆä¸éœ€è¦CASæ›´æ–°stateï¼Ÿ
            //å› ä¸ºå½“å‰çº¿ç¨‹å æœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹åªä¼šCASæŠŠstateä»0æ›´æ–°åˆ°1ï¼Œæ˜¯ä¸ä¼šæˆåŠŸçš„
            //æ‰€ä»¥ä¸å­˜åœ¨ç«äº‰ï¼Œè‡ªç„¶ä¸éœ€è¦ä½¿ç”¨CASæ¥æ›´æ–°
            setState(nextc);
            //å½“çº¿ç¨‹è·å–é”æˆåŠŸ
            return true;
        }
        //å½“çº¿ç¨‹è·å–é”å¤±è´¥
        return false;
    }


    public final boolean hasQueuedPredecessors() {
        //å°¾éƒ¨
        Node t = tail;
        //å¤´éƒ¨
        Node h = head;
        Node s;
        // h != t æ—¶è¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰ Node
        return h != t &&
                // (s = h.next) == null è¡¨ç¤ºé˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰è€äºŒ
                ((s = h.ext) == null ||
                        // æˆ–è€…é˜Ÿåˆ—ä¸­è€äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹
           
                        s.thread != Thread.currentThread());
    }


5.[æ¡ä»¶å˜é‡](https://so.csdn.net/so/search?q=%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F&spm=1001.2101.3001.7020)å®ç°åŸç†
----------------------------------------------------------------------------------------------------------

æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯ `ConditionObject`

### 5.1 await æµç¨‹

å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ `await`ï¼Œè¿›å…¥ ConditionObject çš„ `addConditionWaiter` æµç¨‹

åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨

![](https://img-blog.csdnimg.cn/img_convert/64819ba7473a0756199bc0283ddff2a2.png)

æ¥ä¸‹æ¥è¿›å…¥ AQS çš„ `fullyRelease` æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”

![](https://img-blog.csdnimg.cn/img_convert/7e35155b6d5370c1e2c1cef1c284720a.png)

unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Thread-1 ç«äº‰æˆåŠŸ

![](https://img-blog.csdnimg.cn/img_convert/cb1d38ee7270469628865a9cba0fa544.png)

park é˜»å¡ Thread-0

![](https://img-blog.csdnimg.cn/img_convert/97d9c3f21d1151547ac4d5440f0376e3.png)

### 5.2 signal æµç¨‹

å‡è®¾ Thread-1 è°ƒç”¨`signal`è¦æ¥å”¤é†’ Thread-0

![](https://img-blog.csdnimg.cn/img_convert/a6052eef6c65ea36ba3fb475d162aa6b.png)

è¿›å…¥ ConditionObject çš„ `doSignal` æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Nodeï¼Œå³ Thread-0 æ‰€åœ¨ Node

![](https://img-blog.csdnimg.cn/img_convert/9496487855165a975e38a4de450f65ae.png)

æ‰§è¡Œ `transferForSignal` æµç¨‹ï¼Œå°†è¯¥ Node åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨ï¼Œå°† Thread-0 çš„ waitStatus æ”¹ä¸º 0ï¼ŒThread-3 çš„ waitStatus æ”¹ä¸º -1

ï¼ˆ**waitStatus == 0 é»˜è®¤çŠ¶æ€ï¼ŒwaitStatus == -1 è¡¨ç¤ºå½“å‰nodeå¦‚æœæ˜¯headèŠ‚ç‚¹æ—¶ï¼Œé‡Šæ”¾é”ä¹‹åéœ€è¦å”¤é†’å®ƒçš„åç»§èŠ‚ç‚¹**ï¼‰

![](https://img-blog.csdnimg.cn/img_convert/b93872a8ee19579c0620f62c362224fc.png)

Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹ï¼Œç•¥



[è¯»å†™é”](https://so.csdn.net/so/search?q=%E8%AF%BB%E5%86%99%E9%94%81&spm=1001.2101.3001.7020)
==========================================================================================

1.ReentrantReadWriteLock
------------------------

### 1.1 æ¦‚è¿°

å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨è¯»å†™é” è®© `è¯»-è¯»` å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚ ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„ `select ... from ... lock in share mode`

æ —å­ï¼š

æä¾›ä¸€ä¸ªæ•°æ®å®¹å™¨ç±»ï¼Œå†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•

    @Slf4j
    class Datacontainer {
        private Object data;
        private ReentrantReadWriteLock rw = new ReentrantReadWriteLock();
        private ReentrantReadWriteLock.ReadLock r = rw.readLock();
        private ReentrantReadWriteLock.WriteLock w = rw.writeLock();
    
        public Object read() {
            r.lock();
            log.debug("è·å–è¯»é”..");
            try {
                log.debug("è¯»å–");
                Sleeper.sleep(1);
                return data;
            } finally {
                log.debug("é‡Šæ”¾è¯»é”...");
                r.unlock();
            }
        }
    
        public void write() {
            w.lock();
            log.debug("è·å–å†™é”...");
            try {
                log.debug("å†™å…¥");
                Sleeper.sleep(1);
            } finally {
                log.debug("é‡Šæ”¾å†™é”...");
                w.unlock();
            }
        }
    }


æµ‹è¯• `è¯»é”-è¯»é”` å¯ä»¥å¹¶å‘ï¼š

    public class TestReadWriteLock {
        public static void main(String[] args) {
            Datacontainer datacontainer = new Datacontainer();
            new Thread(() -> {
                datacontainer.read();
            }, "t1").start();
            new Thread(() -> {
                datacontainer.read();
            }, "t2").start();
        }
    }


è¾“å‡ºç»“æœï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ° Thread-0 é”å®šæœŸé—´ï¼ŒThread-1 çš„è¯»æ“ä½œä¸å—å½±å“ï¼š

![](https://img-blog.csdnimg.cn/img_convert/0fdf95b57696d9f91905c2e96136dcf4.png)

æµ‹è¯• `è¯»é”-å†™é”` ç›¸äº’é˜»å¡ï¼š

    @Slf4j
    public class TestReadWriteLock {
        public static void main(String[] args) throws InterruptedException {
            Datacontainer datacontainer = new Datacontainer();
            new Thread(() -> {
                datacontainer.read();
            }, "t1").start();
            Thread.sleep(100);
            new Thread(() -> {
                datacontainer.write();
            }, "t2").start();
        }
    }


ç»“æœï¼š

![](https://img-blog.csdnimg.cn/img_convert/887d8f7fae432d8a59ec362def56b20f.png)

> **æ³¨æ„ï¼š**
>
> *   è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡
> *   é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…
> *   é‡å…¥æ—¶é™çº§æ”¯æŒï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”

çœ‹ä¸€ä¸ªé‡å…¥é™çº§è·å¾—é”æ —å­ï¼š

    class CachedData {
        Object data;
        // æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®— data
        volatile boolean cacheValid;
        final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
        void processCachedData() {
            rwl.readLock().lock();
            if (!cacheValid) {
                // è·å–å†™é”å‰å¿…é¡»é‡Šæ”¾è¯»é”
                rwl.readLock().unlock();
                rwl.writeLock().lock();
                try {
                    // åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»è·å–äº†å†™é”ã€æ›´æ–°äº†ç¼“å­˜, é¿å…é‡å¤æ›´æ–°
                    if (!cacheValid) {
                        data = ...
                            cacheValid = true;
                    }
                    // é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜
                    rwl.readLock().lock();
                } finally {
                    rwl.writeLock().unlock();
                }
            }
            // è‡ªå·±ç”¨å®Œæ•°æ®, é‡Šæ”¾è¯»é” 
            try {
                use(data);
            } finally {
                rwl.readLock().unlock();
            }
        }
    }


### 1.2 åŸç†æ¼”ç¤º

è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ªã€‚

#### t1 w.lockï¼Œt2 r.lock

1ï¼‰ t1 æˆåŠŸä¸Šé”ï¼Œæµç¨‹ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯**å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½**

![](https://img-blog.csdnimg.cn/img_convert/481ebcca94c7f6495512490c91523a9f.png)

2ï¼‰t2 æ‰§è¡Œ r.`lock`ï¼Œè¿™æ—¶è¿›å…¥è¯»é”çš„ sync.`acquireShared`(1) æµç¨‹ï¼Œé¦–å…ˆä¼šè¿›å…¥ `tryAcquireShared` æµç¨‹ã€‚å¦‚æœæœ‰å†™é”å æ®ï¼Œé‚£ä¹ˆ tryAcquireShared è¿”å› -1 è¡¨ç¤ºå¤±è´¥

> tryAcquireShared è¿”å›å€¼è¡¨ç¤ºï¼š
>
> *   \-1 è¡¨ç¤ºå¤±è´¥
> *   0 è¡¨ç¤ºæˆåŠŸ
> *   æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼ˆè€Œä¸”æ•°å€¼æ˜¯è¿˜æœ‰å‡ ä¸ªåç»§èŠ‚ç‚¹éœ€è¦å”¤é†’ï¼Œè¯»å†™é”è¿”å›1ï¼‰

![](https://img-blog.csdnimg.cn/img_convert/2df9cd299203ab789966ff191a76cb9f.png)

3ï¼‰è¿™æ—¶ä¼šè¿›å…¥ sync.`doAcquireShared`(1) æµç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ `addWaiter` æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º `Node.SHARED` æ¨¡å¼è€Œé Node.EXCLUSIVE æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€

![](https://img-blog.csdnimg.cn/img_convert/b8f7865b3301484710f2d605e6407af2.png)

4ï¼‰t2 ä¼šçœ‹çœ‹è‡ªå·±çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯è€äºŒï¼Œå¦‚æœæ˜¯ï¼Œè¿˜ä¼šå†æ¬¡è°ƒç”¨ `tryAcquireShared`(1) æ¥å°è¯•è·å–é”

5ï¼‰å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… `for (;;)` å¾ªç¯ä¸€æ¬¡ï¼ŒæŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;ğŸ˜‰ å¾ªç¯ä¸€ æ¬¡å°è¯• tryAcquireShared(1) å¦‚æœè¿˜ä¸æˆåŠŸï¼Œé‚£ä¹ˆåœ¨ `parkAndCheckInterrupt`() å¤„ park

![](https://img-blog.csdnimg.cn/img_convert/62cc6d372b363dc5cb9a0b5746543b43.png)

#### t3 r.lockï¼Œt4 w.lock

è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 åŠ è¯»é”å’Œ t4 åŠ å†™é”ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­

![](https://img-blog.csdnimg.cn/img_convert/bae74395ae2c14faa59f85e1628ad490.png)

#### t1 w.unlock

è¿™æ—¶ä¼šèµ°åˆ°å†™é”çš„ sync.`release`(1) æµç¨‹ï¼Œè°ƒç”¨ sync.`tryRelease`(1) æˆåŠŸï¼Œå˜æˆä¸‹é¢çš„æ ·å­

![](https://img-blog.csdnimg.cn/img_convert/264910b419ea53fc24a0f706881126f4.png)

æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æµç¨‹ sync.`unparkSuccessor`ï¼Œå³è®©è€äºŒæ¢å¤è¿è¡Œï¼Œè¿™æ—¶ t2 åœ¨ `doAcquireShared` å†… `parkAndCheckInterrupt` å¤„æ¢å¤è¿è¡Œ è¿™å›å†æ¥ä¸€æ¬¡ `for (;;)` æ‰§è¡Œ `tryAcquireShared` æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€

![](https://img-blog.csdnimg.cn/img_convert/107f4c102050227bd3aa3c540e041eb3.png)

è¿™æ—¶ t2 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t2 è°ƒç”¨ `setHeadAndPropagate`(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹

![](https://img-blog.csdnimg.cn/img_convert/0a3709af03b1bd0cf7596910711c1ad1.png)

äº‹æƒ…è¿˜æ²¡å®Œï¼Œåœ¨ `setHeadAndPropagate` æ–¹æ³•å†…è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ `shared`ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ `doReleaseShared`() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œè¿™æ—¶ t3 åœ¨ `doAcquireShared` å†… `parkAndCheckInterrupt`å¤„æ¢å¤è¿è¡Œ

![](https://img-blog.csdnimg.cn/img_convert/991f6f80457d95d236c9eb106917649a.png)

è¿™å›å†æ¥ä¸€æ¬¡ `for (;;)` æ‰§è¡Œ `tryAcquireShared` æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€

![](https://img-blog.csdnimg.cn/img_convert/98e2a30ae43c214d84e29722a9a2924d.png)

è¿™æ—¶ t3 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t3 è°ƒç”¨ `setHeadAndPropagate`(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹

![](https://img-blog.csdnimg.cn/img_convert/ecb0ac3bc54e9a38caeea7a572a965c2.png)

ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ `shared` äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹

#### t2 r.unlockï¼Œt3 r.unlock

t2 è¿›å…¥ sync.`releaseShared`(1) ä¸­ï¼Œè°ƒç”¨ `tryReleaseShared`(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†ç”±äºè®¡æ•°è¿˜ä¸ä¸ºé›¶

![](https://img-blog.csdnimg.cn/img_convert/85b8353af5634066930135d2ca922098.png)

t3 è¿›å…¥ sync.`releaseShared`(1) ä¸­ï¼Œè°ƒç”¨ `tryReleaseShared`(1) è®©è®¡æ•°å‡ä¸€ï¼Œè¿™å›è®¡æ•°ä¸ºé›¶äº†ï¼Œè¿›å…¥ `doReleaseShared`() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œå³

![](https://img-blog.csdnimg.cn/img_convert/ace5f84a3eb33c01c50b03920b42498f.png)

ä¹‹å t4 åœ¨ `acquireQueued` ä¸­ `parkAndCheckInterrupt` å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ `for (;;)` è¿™æ¬¡è‡ªå·±æ˜¯è€äºŒï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–ç«äº‰ï¼Œ`tryAcquire`(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ

![](https://img-blog.csdnimg.cn/img_convert/dc7ac318785511e384b0e749b9b3e434.png)

2.StampedLock
-------------

### 2.1 æ¦‚è¿°

è¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆã€æˆ³ã€‘ä½¿ç”¨

åŠ è§£è¯»é”ï¼š

    long stamp = lock.readLock();
    lock.unlockRead(stamp);


åŠ è§£å†™é”ï¼š

    long stamp = lock.writeLock();
    lock.unlockWrite(stamp);


**ä¹è§‚è¯»**ï¼š`StampedLock` æ”¯æŒ `tryOptimisticRead()` æ–¹æ³•ï¼ˆä¹è§‚è¯»ï¼‰ï¼Œè¯»å–å®Œæ¯•åéœ€è¦åšä¸€æ¬¡æˆ³æ ¡éªŒå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯[æ•°æ®å®‰å…¨](https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8&spm=1001.2101.3001.7020)ã€‚

    long stamp = lock.tryOptimisticRead();
    // éªŒæˆ³
    if(!lock.validate(stamp)){
     // é”å‡çº§
    }


### 2.2 ä¾‹å­

æä¾›ä¸€ä¸ª æ•°æ®å®¹å™¨ç±» å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•ï¼š

    @Slf4j
    class DataContainerStamper {
        private int data;
        private final StampedLock lock = new StampedLock();
    
        public DataContainerStamper(int data) {
            this.data = data;
        }
    
        public int read(int readTime) {
            //ä¹è§‚è¯»
            long stamp = lock.tryOptimisticRead();
            log.debug("optimistic read lockuing ... {}", stamp);
            //æ¨¡æ‹Ÿè¯»å–æ—¶é—´
            Sleeper.sleep(readTime);
            //æ ¡éªŒæˆ³ï¼Œé€šè¿‡ç›´æ¥è¿”å›
            if (lock.validate(stamp)) {
                log.debug("read finish... {}", stamp);
                return data;
            }
            //é”çš„å‡çº§->è¯»é”
            log.debug("updating to read lock... {}", stamp);
            try {
                //è·å–è¯»é”
                stamp = lock.readLock();
                log.debug("read lock {}", stamp);
                Sleeper.sleep(readTime);
                log.debug("read finish... {}", stamp);
                return data;
            } finally {
                log.debug("read unlock {}", stamp);
                //é‡Šæ”¾è¯»é”
                lock.unlockRead(stamp);
            }
    
        }
    
        public void write(int newData) {
            //åŠ å†™é”
            long stamp = lock.writeLock();
            log.debug("write lock {}", stamp);
            try {
                Sleeper.sleep(2);
                this.data = newData;
            } finally {
                log.debug("write unlock {}", stamp);
                //é‡Šæ”¾å†™é”ï¼Œéœ€è¦ä¼ å…¥æˆ³
                lock.unlockWrite(stamp);
            }
        }
    }


æµ‹è¯• `è¯»-è¯»` å¯ä»¥ä¼˜åŒ–ï¼š

    public class TestStampedLock {
        public static void main(String[] args) {
            DataContainerStamper dataContainer = new DataContainerStamper(1);
            new Thread(() -> {
                dataContainer.read(1);
            }, "t1").start();
            Sleeper.sleep(0.5);
            new Thread(() -> {
                dataContainer.read(0);
            }, "t2").start();
        }
    }


è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°å®é™…æ²¡æœ‰åŠ è¯»é”ï¼š

![](https://img-blog.csdnimg.cn/img_convert/0656b6b6f00dc88ad7991a2f3ca3036f.png)

æµ‹è¯• `è¯»-å†™` æ—¶ä¼˜åŒ–è¯»è¡¥åŠ è¯»é”ï¼š

    public class TestStampedLock {
        public static void main(String[] args) {
            DataContainerStamper dataContainer = new DataContainerStamper(1);
            new Thread(() -> {
                dataContainer.read(1);
            }, "t1").start();
            Sleeper.sleep(0.5);
            new Thread(() -> {
                dataContainer.write(0);
            }, "t2").start();
        }
    }


è¾“å‡ºç»“æœï¼š

![](https://img-blog.csdnimg.cn/img_convert/20fb96b9498beccfda9ef586f966ad3f.png)

> **æ³¨æ„ï¼š**
>
> *   StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡
> *   StampedLock ä¸æ”¯æŒå¯é‡å…¥
